<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>æª¢æŸ¥æ’ç¨‹è¡¨å–®</title>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<style>
    option.used-slot{color:red !important; font-weight:bold;}
    option.sealed-slot { color: #007bff !important; font-style: italic; }
    body { font-family: sans-serif; max-width: 1200px; margin: auto; padding: 20px; display: flex; flex-direction: column; }
    input, select, button, textarea {
      display: block; width: 100%; margin: 10px 0; padding: 8px; font-size: 16px;
    }
    button { background-color: #4CAF50; color: white; border: none; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    th { background: #f0f0f0; }
    @media print { .noprint { display: none !important; } }
    #sealPanel { float: right; border: 1px solid #ccc; padding: 10px; margin-left: 20px; width: 280px; background: #f9f9f9; }
    #formSection { flex: 1; max-width: 800px; }

    body {
      font-family: "Segoe UI", "Noto Sans TC", sans-serif;
      background: url('8c829460-d144-11e9-8e6f-74942275b45f.jpg') no-repeat center center fixed;
      background-size: cover;
      backdrop-filter: blur(4px);
      color: #333;
    }
    input, select, button, textarea {
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    button {
      background-color: #ffd1dc;
      color: black;
      transition: 0.3s ease;
    }
    button:hover {
      background-color: #f48fb1;
    }
    table {
      background: rgba(255,255,255,0.95);
    }
    th {
      background: #ffe4ec;
      color: #880e4f;
    }
    #sealPanel {
      background: rgba(255,255,255,0.85);
    }

    /* ç”¨æ–¼å°å°é¸é …æ¨™ç±¤çš„å°é½Š */
    #sealPanel label.seal-option {
        display: flex; /* ä½¿ç”¨ Flexbox å¸ƒå±€ */
        align-items: center; /* å‚ç›´ç½®ä¸­å°é½Š */
        margin-bottom: 8px; /* èˆ‡ä¸‹æ–¹å…ƒç´ çš„é–“è· */
    }
    #sealPanel label.seal-option input[type="checkbox"] {
        width: auto; /* è®“ checkbox æ ¹æ“šå…§å®¹è‡ªå‹•èª¿æ•´å¯¬åº¦ */
        margin-right: 8px; /* checkbox èˆ‡æ–‡å­—ä¹‹é–“çš„é–“è· */
        margin-top: 0; /* ç§»é™¤ input é è¨­çš„ä¸Šé‚Šè·ï¼Œäº¤ç”± flex æ§åˆ¶ */
        margin-bottom: 0; /* ç§»é™¤ input é è¨­çš„ä¸‹é‚Šè· */
    }


    @media print {
      body * {
        visibility: hidden !important;
      }
      #printCombinedArea, #printCombinedArea * {
        visibility: visible !important;
      }
      #printCombinedArea {
        position: absolute;
        top: 0;
        left: 0;
        width: 90%;
        margin: 20px auto;
        background: white;
        padding: 15px;
        font-size: 12px; /* åˆ—å°å­—é«”å¤§å° */
        box-shadow: 0 0 10px rgba(0,0,0,0.2);
      }
      #printCombinedArea table {
        font-size: 11px; /* åˆ—å°è¡¨æ ¼å­—é«”å¤§å° */
        width: 100%;
        margin: auto;
        border-collapse: collapse;
      }
      #printCombinedArea th, #printCombinedArea td {
        border: 1px solid #ccc;
        padding: 3px;
      }
      #printCombinedArea h3 {
        font-size: 16px; /* åˆ—å°æ¨™é¡Œå­—é«”å¤§å° */
      }
    }

    table th:nth-child(1), /* Name */
    table td:nth-child(1) {
      width: 100px;
    }
    table th:nth-child(2), /* Chart */
    table td:nth-child(2) {
      width: 80px;
    }
     table th:nth-child(3), /* Part */
    table td:nth-child(3) {
      width: auto; /* Let part take remaining space */
    }
    table th:nth-child(4), /* Date (in list) */
    table td:nth-child(4) {
      width: 90px;
    }
    table th:nth-child(5), /* Time (in list) */
    table td:nth-child(5) {
      width: 120px;
    }


    #recordTable th, #recordTable td {
      color: #000 !important;
    }
</style>
</head>
<body>

<div id="loginForm">
<h3>ğŸ”’ è«‹è¼¸å…¥å¯†ç¢¼é€²å…¥ç³»çµ±</h3>
<input id="passwordInput" placeholder="è¼¸å…¥å¯†ç¢¼" type="password"/>
<button onclick="checkPassword()">ç™»å…¥</button>
</div>

<div id="protected" style="display:none;">
  <div style="display: flex; justify-content: space-between; align-items: flex-start;">
    <div id="formSection">
      <div class="noprint" style="margin-bottom:10px;"><img src="logo.png" style="height:60px;" alt="Logo"></div>
      <h2>æª¢æŸ¥æ’ç¨‹è¡¨å–®ï¼ˆ<span id="modeTitle">CT</span> æ¨¡çµ„ï¼‰</h2>
      <div style="margin-bottom:10px;">
        <button onclick="switchMode('CT')">åˆ‡æ›ç‚º CT</button>
        <button onclick="switchMode('MRI')">åˆ‡æ›ç‚º MRI</button>
        <button onclick="switchMode('BD')">åˆ‡æ›ç‚º BD</button>
        <button onclick="switchMode('IVP')">åˆ‡æ›ç‚º IVP</button>
      </div>
      <div>ğŸ“… ä»Šæ—¥æ—¥æœŸï¼š<span id="todayBanner"></span></div>
      <button onclick="simulateCardRead()" style="margin-bottom:10px;">ğŸ”˜ æ¨¡æ“¬è®€å¡ï¼ˆç‹å°æ˜ï¼‰</button>
      <div id="lookupResult" style="font-weight:bold; margin-top:10px; margin-bottom:10px; min-height: 20px;"></div>
      <label>ç—…äººå§“åï¼š<input id="name"/></label>
      <label>ç—…æ­·è™Ÿï¼š<input id="chart"/></label>
      <label>æª¢æŸ¥éƒ¨ä½ï¼š
        <input id="part" list="ctPartsList" placeholder="è«‹è¼¸å…¥æˆ–é¸æ“‡éƒ¨ä½">
        <datalist id="ctPartsList">
          <option value="å¿ƒè‡Ÿéˆ£åŒ–é›»è…¦æ–·å±¤æ”å½± Calcification(ä¸æ‰“è—¥)">
          <option value="å¿ƒè‡Ÿé›»è…¦æ–·å±¤è¡€ç®¡æ”å½±å¥—çµ„ HEART CTA+Calcification(æ‰“è—¥)">
          <option value="é ­éƒ¨ brain(æ‰“è—¥)">
          <option value="é ­éƒ¨ brain(ä¸æ‰“è—¥)">
          <option value="é ¸éƒ¨ neck(æ‰“è—¥)">
          <option value="é ¸éƒ¨ neck(ä¸æ‰“è—¥)">
          <option value="é ¸æ¤ c-spine(æ‰“è—¥)">
          <option value="é ¸æ¤ c-spine(ä¸æ‰“è—¥)">
          <option value="èƒ¸éƒ¨ chest(æ‰“è—¥)">
          <option value="èƒ¸éƒ¨ chest(ä¸æ‰“è—¥)">
          <option value="ä½è¼»å°„åŠ‘é‡è‚ºéƒ¨ç¯©æª¢ Low dose lung screen(ä¸æ‰“è—¥)">
          <option value="é«˜è§£æè‚ºéƒ¨ HRCT(ä¸æ‰“è—¥)">
          <option value="è…¹éƒ¨ Abdomen+PELVIS(æ‰“è—¥)">
          <option value="è…¹éƒ¨ Abdomen+PELVIS(ä¸æ‰“è—¥)">
          <option value="è…°æ¤ L-spine(æ‰“è—¥)">
          <option value="è…°æ¤ L-spine(ä¸æ‰“è—¥)">
          <option value="èƒ¸æ¤ T-spine(æ‰“è—¥)">
          <option value="èƒ¸æ¤ T-spine(ä¸æ‰“è—¥)">
          <option value="4è‚¢ Limbs(æ‰“è—¥)">
          <option value="4è‚¢ Limbs(ä¸æ‰“è—¥)">
        </datalist>
      </label>
      <label>æª¢æŸ¥æ—¥æœŸï¼š<input id="date" onchange="disableUsedTimeSlots()" type="date"/></label>
      <label>æª¢æŸ¥æ™‚æ®µï¼š
        <select id="time"></select>
      </label>
      <label>å‚™è¨»ï¼š<textarea id="note"></textarea></label>
      <button onclick="submitForm()">é€å‡ºæ’ç¨‹</button>
      <h3>ğŸ“‹ å·²é ç´„æ¸…å–®</h3>
      <label>ç¯©é¸æ—¥æœŸï¼š<input id="dateFilter" onchange="renderTable()" type="date"/></label>
      <input id="search" oninput="renderTable()" placeholder="æœå°‹å§“åã€ç—…æ­·è™Ÿã€éƒ¨ä½æˆ–æ™‚æ®µ..."/>
      <button onclick="loadRecords()">è¼‰å…¥é ç´„ç´€éŒ„</button>
      <button onclick="generateCombinedPrint()">ç”¢å‡ºåˆ—å°ç¸½è¡¨</button>
      <table id="recordTable">
        <thead><tr><th>å§“å</th><th>ç—…æ­·è™Ÿ</th><th>éƒ¨ä½</th><th>æ—¥æœŸ</th><th>æ™‚æ®µ</th><th>å‚™è¨»</th><th class="noprint">æ“ä½œ</th></tr></thead>
        <tbody></tbody>
      </table>
      <div id="printCombinedArea" style="display:none; margin-top:30px;"></div>
    </div>

    <div id="sealPanel" style="display:none;">
      <h4>ğŸ“Œ å°å°æ’æª¢æ™‚æ®µç®¡ç† (<span id="sealModeTitle">CT</span>)</h4>
      <label>é¸æ“‡æ—¥æœŸï¼š<input id="sealDate" type="date"/></label>
      <label class="seal-option"><input id="sealAM" type="checkbox"/><span>å°å°ä¸Šåˆ</span></label>
      <label class="seal-option"><input id="sealPM" type="checkbox"/><span>å°å°ä¸‹åˆ</span></label>
      <button onclick="saveSeal()">å„²å­˜å°å°è¨­å®š</button>
      <div style="margin-top: 20px;">
        <h4>ğŸ“‹ <span id="sealSummaryTitle">CT</span> å°å°ç¸½è¦½</h4>
        <ul id="sealSummaryList" style="padding-left: 20px; max-height: 200px; overflow-y: auto;"></ul>
      </div>
    </div>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBLgUdGaDarOAQF_5YGo4df6KyU8DsclA0", // è«‹æ›¿æ›æˆæ‚¨è‡ªå·±çš„ Firebase API Key
  authDomain: "ct-reserve.firebaseapp.com", // è«‹æ›¿æ›æˆæ‚¨è‡ªå·±çš„ Firebase Auth Domain
  databaseURL: "https://ct-reserve-default-rtdb.firebaseio.com", // è«‹æ›¿æ›æˆæ‚¨è‡ªå·±çš„ Firebase Database URL
  projectId: "ct-reserve", // è«‹æ›¿æ›æˆæ‚¨è‡ªå·±çš„ Firebase Project ID
  storageBucket: "ct-reserve.appspot.com", // è«‹æ›¿æ›æˆæ‚¨è‡ªå·±çš„ Firebase Storage Bucket
  messagingSenderId: "263734590112", // è«‹æ›¿æ›æˆæ‚¨è‡ªå·±çš„ Firebase Messaging Sender ID
  appId: "1:263734590112:web:34fec465ce56d91f68a7c5" // è«‹æ›¿æ›æˆæ‚¨è‡ªå·±çš„ Firebase App ID
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let mode = 'CT'; // ç•¶å‰æ“ä½œçš„æ¨¡çµ„ (CT, MRI, BD, IVP)
let allData = []; // ç•¶å‰æ¨¡çµ„è¼‰å…¥çš„æ‰€æœ‰é ç´„è³‡æ–™
let currentModeActiveSeals = {}; // ç•¶å‰æ¨¡çµ„ (CTæˆ–MRI) çš„å°å°è³‡æ–™

// å„æ¨¡çµ„çš„æª¢æŸ¥éƒ¨ä½åˆ—è¡¨
const ctParts = [
  "è«‹é¸æ“‡", "å¿ƒè‡Ÿéˆ£åŒ–é›»è…¦æ–·å±¤æ”å½± Calcification(ä¸æ‰“è—¥)", "å¿ƒè‡Ÿé›»è…¦æ–·å±¤è¡€ç®¡æ”å½±å¥—çµ„ HEART CTA+Calcification(æ‰“è—¥)",
  "é ­éƒ¨ brain(æ‰“è—¥)", "é ­éƒ¨ brain(ä¸æ‰“è—¥)", "é ¸éƒ¨ neck(æ‰“è—¥)", "é ¸éƒ¨ neck(ä¸æ‰“è—¥)",
  "é ¸æ¤ c-spine(æ‰“è—¥)", "é ¸æ¤ c-spine(ä¸æ‰“è—¥)", "èƒ¸éƒ¨ chest(æ‰“è—¥)", "èƒ¸éƒ¨ chest(ä¸æ‰“è—¥)",
  "ä½è¼»å°„åŠ‘é‡è‚ºéƒ¨ç¯©æª¢ Low dose lung screen(ä¸æ‰“è—¥)", "é«˜è§£æè‚ºéƒ¨ HRCT(ä¸æ‰“è—¥)",
  "è…¹éƒ¨ Abdomen+PELVIS(æ‰“è—¥)", "è…¹éƒ¨ Abdomen+PELVIS(ä¸æ‰“è—¥)", "è…°æ¤ L-spine(æ‰“è—¥)", "è…°æ¤ L-spine(ä¸æ‰“è—¥)",
  "èƒ¸æ¤ T-spine(æ‰“è—¥)", "èƒ¸æ¤ T-spine(ä¸æ‰“è—¥)", "4è‚¢ Limbs(æ‰“è—¥)", "4è‚¢ Limbs(ä¸æ‰“è—¥)"
];
const bdParts = [ "è«‹é¸æ“‡", "è…°æ¤éª¨è³ªå¯†åº¦(L-SPINE)", "å…©å´é«–é—œç¯€éª¨è³ªå¯†åº¦(Bilateral HIP)", "è…°æ¤éª¨è³ªå¯†åº¦(L-SPINE) + å…©å´é«–é—œç¯€éª¨è³ªå¯†åº¦(Bilateral HIP)", "è…°æ¤å´ä½éª¨è³ªå¯†åº¦(L-SPINE Lateral)" ];
const ivpParts = [ "è«‹é¸æ“‡", "éœè„ˆæ³¨å°„æ³Œå°¿ç³»çµ±æ”å½±æª¢æŸ¥(IVP)" ];
const mriParts = [ // MRI æª¢æŸ¥éƒ¨ä½ (å¯è‡ªè¨‚)
  "è«‹é¸æ“‡", "MRI é ­éƒ¨ Brain (ä¸æ‰“è—¥)", "MRI é ­éƒ¨ Brain (æ‰“è—¥)", "MRI é ¸æ¤ C-spine (ä¸æ‰“è—¥)",
  "MRI èƒ¸æ¤ T-spine (ä¸æ‰“è—¥)", "MRI è…°æ¤ L-spine (ä¸æ‰“è—¥)", "MRI éª¨ç›† Pelvis (ä¸æ‰“è—¥)",
  "MRI è‚©é—œç¯€ Shoulder (ä¸æ‰“è—¥)", "MRI è‚˜é—œç¯€ Elbow (ä¸æ‰“è—¥)", "MRI è…•é—œç¯€ Wrist (ä¸æ‰“è—¥)",
  "MRI é«–é—œç¯€ Hip (ä¸æ‰“è—¥)", "MRI è†é—œç¯€ Knee (ä¸æ‰“è—¥)", "MRI è¸é—œç¯€ Ankle (ä¸æ‰“è—¥)",
  "MRI ä¹³æˆ¿ Breast (æ‰“è—¥)"
];

/**
 * åˆ‡æ›æ“ä½œæ¨¡çµ„ (CT, MRI, BD, IVP)
 * @param {string} newMode - æ–°çš„æ¨¡çµ„åç¨±
 */
function switchMode(newMode) {
  mode = newMode;
  document.getElementById("modeTitle").textContent = mode; // æ›´æ–°æ¨™é¡Œä¸­çš„æ¨¡çµ„åç¨±
  document.getElementById("sealModeTitle").textContent = mode; // æ›´æ–°å°å°é¢æ¿çš„æ¨¡çµ„åç¨±
  document.getElementById("sealSummaryTitle").textContent = mode; // æ›´æ–°å°å°ç¸½è¦½çš„æ¨¡çµ„åç¨±
  // åªæœ‰ CT å’Œ MRI æ¨¡çµ„é¡¯ç¤ºå°å°é¢æ¿
  document.getElementById("sealPanel").style.display = (mode === "CT" || mode === "MRI") ? "block" : "none";

  const partContainer = document.getElementById("part").parentElement; // æª¢æŸ¥éƒ¨ä½çš„å®¹å™¨
  let partInputHtml = ''; // æª¢æŸ¥éƒ¨ä½è¼¸å…¥æ¬„ä½çš„ HTML

  // æ ¹æ“šæ¨¡çµ„è¨­å®šæª¢æŸ¥éƒ¨ä½çš„è¼¸å…¥æ–¹å¼ (datalist æˆ– select)
  if (mode === "CT") {
    partInputHtml = `<input id="part" list="ctPartsDataList" placeholder="è«‹è¼¸å…¥æˆ–é¸æ“‡CTéƒ¨ä½">
                     <datalist id="ctPartsDataList">${ctParts.slice(1).map(p => `<option value="${p}">`).join('')}</datalist>`;
  } else if (mode === "MRI") {
    partInputHtml = `<input id="part" list="mriPartsDataList" placeholder="è«‹è¼¸å…¥æˆ–é¸æ“‡MRIéƒ¨ä½">
                     <datalist id="mriPartsDataList">${mriParts.slice(1).map(p => `<option value="${p}">`).join('')}</datalist>`;
  } else { // BD å’Œ IVP ä½¿ç”¨ä¸‹æ‹‰é¸å–®
    const partsList = mode === "BD" ? bdParts : ivpParts;
    const partSelect = document.createElement("select");
    partSelect.id = "part";
    partSelect.innerHTML = partsList.map(p => `<option value="${p}">${p}</option>`).join('');
    partContainer.innerHTML = "æª¢æŸ¥éƒ¨ä½ï¼š<br>"; // æ¸…ç©ºä¸¦è¨­å®šæ¨™é¡Œ
    partContainer.appendChild(partSelect);
  }

  // å¦‚æœæ˜¯ CT æˆ– MRIï¼Œå‰‡ä½¿ç”¨ datalist
  if (mode === "CT" || mode === "MRI") {
      partContainer.innerHTML = `æª¢æŸ¥éƒ¨ä½ï¼š<br>${partInputHtml}`;
  }

  // æ ¹æ“šæ¨¡çµ„è¨­å®šæª¢æŸ¥æ™‚æ®µçš„é¸é …
  const timeSelect = document.getElementById("time");
  let timeOptions = ['<option value="">è«‹é¸æ“‡</option>']; // é è¨­é¸é …
  if (mode === "CT") {
    timeOptions.push(
      '<option value="(HEART CTA+éˆ£åŒ–åˆ†æ)1">(HEART CTA+éˆ£åŒ–åˆ†æ)1</option>',
      '<option value="(HEART CTA+éˆ£åŒ–åˆ†æ)2">(HEART CTA+éˆ£åŒ–åˆ†æ)2</option>',
      '08:00', '08:20', '08:40', '09:00', '09:20', '09:40', '10:00', '10:20', '10:40',
      '11:00', '11:20 tumor', '11:40 ç—…æˆ¿', '13:20', '13:40', '14:00', '14:20',
      '14:40', '15:00', '15:20', '15:40', '16:00 ç—…æˆ¿'
    );
  } else if (mode === "MRI") { // MRI æ™‚æ®µ (å¯è‡ªè¨‚)
    timeOptions.push(
      '08:00', '08:30', '09:00', '09:30', '10:00', '10:30', '11:00', '11:30',
      '13:30', '14:00', '14:30', '15:00', '15:30', '16:00', '16:30'
    );
  } else { // BD, IVP æ™‚æ®µ (èˆ‡ CT ç›¸åŒ)
    timeOptions.push(
      '08:00', '08:20', '08:40', '09:00', '09:20', '09:40', '10:00', '10:20', '10:40',
      '11:00', '11:20 tumor', '11:40 ç—…æˆ¿', '13:20', '13:40', '14:00', '14:20',
      '14:40', '15:00', '15:20', '15:40', '16:00 ç—…æˆ¿'
    );
  }
  timeSelect.innerHTML = timeOptions.map(t => t.startsWith('<opt') ? t : `<option value="${t}">${t}</option>`).join('');

  // ç‰¹æ®Šæ™‚æ®µæ¨™è‰²
  Array.from(timeSelect.options).forEach(function(opt) {
    if (opt.text.includes("(HEART CTA+éˆ£åŒ–åˆ†æ)")) {
      opt.style.color = 'green';
      opt.style.fontWeight = 'bold';
    }
  });

  document.getElementById("part").value = ""; // æ¸…ç©ºæª¢æŸ¥éƒ¨ä½
  document.getElementById("time").value = ""; // æ¸…ç©ºæª¢æŸ¥æ™‚æ®µ
  loadRecords(); // é‡æ–°è¼‰å…¥è©²æ¨¡çµ„çš„é ç´„ç´€éŒ„å’Œå°å°ç‹€æ…‹
}

/**
 * æ¸…ç†ä¸€å€‹æœˆå‰çš„èˆŠé ç´„ç´€éŒ„å’Œå°å°è³‡æ–™
 */
function cleanupOldRecords() {
  const today = new Date();
  const cutoff = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate()); // ä¸€å€‹æœˆå‰çš„æ—¥æœŸ

  // æ¸…ç†å„æ¨¡çµ„çš„é ç´„ç´€éŒ„
  const appointmentPaths = ["appointments", "bd_appointments", "ivp_appointments", "mri_appointments"];
  appointmentPaths.forEach(path => {
    db.ref(path).orderByChild("createdAt").endAt(cutoff.getTime()).once("value", snap => {
      snap.forEach(child => {
         db.ref(path + "/" + child.key).remove();
      });
    });
  });

  // æ¸…ç† CT å’Œ MRI çš„å°å°è³‡æ–™
  const sealPaths = ["seals_ct", "seals_mri"];
  sealPaths.forEach(path => {
    db.ref(path).once("value", snap => {
      snap.forEach(child => {
        const sealDate = new Date(child.key); // æ—¥æœŸå­—ä¸² "YYYY-MM-DD"
        if (sealDate < cutoff) {
          db.ref(path + "/" + child.key).remove();
        }
      });
    });
  });
}

/**
 * æ›´æ–°æª¢æŸ¥æ™‚æ®µä¸‹æ‹‰é¸å–®çš„ç‹€æ…‹ (éš±è—å·²é ç´„æ™‚æ®µï¼Œæ¨™ç¤ºå°å°æ™‚æ®µ)
 * æ­¤å‡½æ•¸çš„é‚è¼¯æœƒçµ±ä¸€è™•ç†ä¸€èˆ¬æ™‚æ®µå’Œç‰¹æ®Šå‘½åæ™‚æ®µ (å¦‚ HEART CTA)ã€‚
 */
function disableUsedTimeSlots() {
  const selectedDate = document.getElementById("date").value; // ç²å–é¸æ“‡çš„æª¢æŸ¥æ—¥æœŸ
  const timeSelect = document.getElementById("time"); // æ™‚æ®µä¸‹æ‹‰é¸å–®

  // é‡è¨­æ‰€æœ‰é¸é …çš„ç‹€æ…‹
  Array.from(timeSelect.options).forEach(opt => {
    opt.disabled = false; // å•Ÿç”¨é¸é …
    opt.style.display = ''; // é¡¯ç¤ºé¸é …
    opt.classList.remove("used-slot", "sealed-slot"); // ç§»é™¤æ¨£å¼
    opt.style.color = ''; // é‡è¨­é¡è‰²
    opt.style.fontWeight = ''; // é‡è¨­å­—é‡
    opt.style.fontStyle = ''; // é‡è¨­å­—é«”æ¨£å¼
    // ç‰¹æ®Šæ™‚æ®µé‡æ–°æ¨™è‰²
    if (opt.text.includes("(HEART CTA+éˆ£åŒ–åˆ†æ)")) {
        opt.style.color = 'green';
        opt.style.fontWeight = 'bold';
    }
  });

  if (!selectedDate) return; // å¦‚æœæ²’æœ‰é¸æ“‡æ—¥æœŸï¼Œå‰‡ä¸é€²è¡Œæ“ä½œ

  // ç²å–å·²é¸æ“‡æ—¥æœŸç•¶å¤©å·²è¢«é ç´„çš„æ™‚æ®µ
  // .map(r => r.time.split(" ").slice(1).join(" "))ç¢ºä¿èƒ½æ­£ç¢ºæå–åŒ…å«ç©ºæ ¼çš„ç‰¹æ®Šæ™‚æ®µåç¨±ä»¥åŠä¸€èˆ¬HH:MMæ™‚æ®µ
  const usedTimesOnSelectedDate = allData
    .filter(r => typeof r.time === "string" && r.time.startsWith(selectedDate))
    .map(r => {
        const parts = r.time.split(" ");
        return parts.slice(1).join(" "); // æ­£ç¢ºæå–å¦‚ "(HEART CTA+éˆ£åŒ–åˆ†æ)1" æˆ– "11:20 tumor"
    });

  // ç²å–ç•¶å‰æ¨¡çµ„åœ¨é¸æ“‡æ—¥æœŸçš„å°å°ç‹€æ…‹
  const dateSeals = (mode === "CT" || mode === "MRI") ? currentModeActiveSeals[selectedDate] : null;

  // éæ­·æ™‚æ®µé¸é …ï¼Œæ›´æ–°ç‹€æ…‹
  Array.from(timeSelect.options).forEach(opt => {
    if (!opt.value || opt.value === "è«‹é¸æ“‡") return; // è·³éé è¨­æç¤ºé¸é …

    let isHidden = false; // æ¨™è¨˜é¸é …æ˜¯å¦æ‡‰è¢«éš±è—

    // æª¢æŸ¥æ™‚æ®µæ˜¯å¦å·²è¢«é ç´„ (æ­¤è™•çš„ opt.value æœƒèˆ‡ usedTimesOnSelectedDate ä¸­çš„å…ƒç´ æ¯”è¼ƒ)
    // å°æ–¼ HEART CTAï¼Œopt.value æ˜¯ "(HEART CTA+éˆ£åŒ–åˆ†æ)1" ç­‰ï¼ŒusedTimesOnSelectedDate ä¹ŸåŒ…å«æ­¤é¡å€¼
    if (usedTimesOnSelectedDate.includes(opt.value)) {
      opt.style.display = 'none'; // ç›´æ¥éš±è—å·²é ç´„çš„æ™‚æ®µ (åŒ…æ‹¬ HEART CTA)
      isHidden = true;
    }

    // å¦‚æœæ™‚æ®µæœªè¢«é ç´„ (æœªéš±è—)ï¼Œå†æª¢æŸ¥æ˜¯å¦è¢«å°å° (åƒ…é™ CT å’Œ MRI çš„ä¸€èˆ¬ HH:MM æ™‚æ®µ)
    // HEART CTA é€™é¡ç‰¹æ®Šå‘½åæ™‚æ®µä¸å— AM/PM å°å°å½±éŸ¿
    if (!isHidden && dateSeals) {
      const [hourStr] = opt.value.split(":"); // æå–å°æ™‚éƒ¨åˆ†ï¼Œä¾‹å¦‚ "08"
      // åªæœ‰ç•¶ opt.value æ˜¯ HH:MM æ ¼å¼æ™‚ï¼ŒparseInt(hourStr) æ‰èƒ½æˆåŠŸè½‰ç‚ºæ•¸å­—
      if (hourStr && !isNaN(parseInt(hourStr))) {
        const hour = parseInt(hourStr);
        let slotIsSealed = false; // æ¨™è¨˜æ™‚æ®µæ˜¯å¦è¢«å°å°
        // åˆ¤æ–·ä¸Šåˆæˆ–ä¸‹åˆæ˜¯å¦å°å°
        if (hour < 12 && dateSeals.am) slotIsSealed = true; // ä¸Šåˆå°å°
        if (hour >= 12 && dateSeals.pm) slotIsSealed = true; // ä¸‹åˆå°å°

        if (slotIsSealed) {
          opt.classList.add("sealed-slot"); // æ·»åŠ å°å°æ¨£å¼
          opt.disabled = true; // è¨­ç‚ºä¸å¯é¸
        }
      }
    }
  });
}

/**
 * æ›´æ–°å°å°ç¸½è¦½åˆ—è¡¨çš„é¡¯ç¤º
 */
function updateSealSummary() {
  const list = document.getElementById("sealSummaryList");
  list.innerHTML = ""; // æ¸…ç©ºèˆŠåˆ—è¡¨
  document.getElementById("sealSummaryTitle").textContent = mode; // æ›´æ–°ç¸½è¦½æ¨™é¡Œçš„æ¨¡çµ„åç¨±

  // åªç‚º CT å’Œ MRI é¡¯ç¤ºå°å°ç¸½è¦½
  if (mode !== "CT" && mode !== "MRI") return;

  // éæ­·ç•¶å‰æ¨¡çµ„çš„å°å°è³‡æ–™ä¸¦é¡¯ç¤º
  Object.keys(currentModeActiveSeals).sort().forEach(date => {
    const s = currentModeActiveSeals[date];
    if (s.am || s.pm) { // å¦‚æœè©²æ—¥æœŸæœ‰å°å°ä¸Šåˆæˆ–ä¸‹åˆ
      const label = `${date}ï¼š${s.am ? "ä¸Šåˆå°å°" : ""}${s.am && s.pm ? "ã€" : ""}${s.pm ? "ä¸‹åˆå°å°" : ""}`;
      const li = document.createElement("li");
      li.textContent = label;
      list.appendChild(li);
    }
  });
}

/**
 * ç•¶å°å°é¢æ¿ä¸­çš„ã€Œé¸æ“‡æ—¥æœŸã€æ”¹è®Šæ™‚ï¼Œæ›´æ–°ã€Œå°å°ä¸Šåˆ/ä¸‹åˆã€å‹¾é¸æ¡†çš„ç‹€æ…‹
 */
function updateSealCheckboxesForSelectedDate() {
  const selectedSealDate = document.getElementById("sealDate").value;
  const sealAMCheckbox = document.getElementById("sealAM");
  const sealPMCheckbox = document.getElementById("sealPM");

  // å¦‚æœæ²’æœ‰é¸æ“‡æ—¥æœŸï¼Œæˆ–è€…ç•¶å‰æ¨¡çµ„ä¸æ˜¯ CT æˆ– MRIï¼Œå‰‡å–æ¶ˆå‹¾é¸æ¡†
  if (!selectedSealDate || (mode !== "CT" && mode !== "MRI")) {
    sealAMCheckbox.checked = false;
    sealPMCheckbox.checked = false;
    return;
  }

  // å¾ currentModeActiveSeals ä¸­æŸ¥æ‰¾æ‰€é¸æ—¥æœŸçš„å°å°ç‹€æ…‹
  const sealsForDate = currentModeActiveSeals[selectedSealDate];

  if (sealsForDate) { // å¦‚æœæ‰¾åˆ°è©²æ—¥æœŸçš„å°å°è³‡æ–™
    sealAMCheckbox.checked = sealsForDate.am || false; // è¨­å®šä¸Šåˆå‹¾é¸æ¡†ç‹€æ…‹
    sealPMCheckbox.checked = sealsForDate.pm || false; // è¨­å®šä¸‹åˆå‹¾é¸æ¡†ç‹€æ…‹
  } else { // å¦‚æœæœªæ‰¾åˆ°ï¼Œè¡¨ç¤ºè©²æ—¥æœªå°å°
    sealAMCheckbox.checked = false;
    sealPMCheckbox.checked = false;
  }
}


/**
 * æª¢æŸ¥ç™»å…¥å¯†ç¢¼
 */
function checkPassword() {
  console.log("checkPassword function called."); // DEBUG
  const passwordInputValue = document.getElementById("passwordInput").value;
  console.log("Password entered:", passwordInputValue); // DEBUG
  if (passwordInputValue === "km1234") {
    console.log("Password correct. Hiding loginForm, showing protected."); // DEBUG
    document.getElementById("protected").style.display = "block";
    document.getElementById("loginForm").style.display = "none";
    initializeForm();
  } else {
    console.log("Password incorrect."); // DEBUG
    alert("å¯†ç¢¼éŒ¯èª¤");
  }
}

// DOMContentLoaded äº‹ä»¶ç›£è½ï¼šé é¢è¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œ
document.addEventListener("DOMContentLoaded", () => {
  console.log("DOMContentLoaded event fired."); // DEBUG
  const passwordInputEl = document.getElementById("passwordInput");
  if (passwordInputEl) {
    console.log("Password input field found."); // DEBUG
    passwordInputEl.addEventListener("keypress", e => {
      if (e.key === "Enter") {
        console.log("Enter key pressed in password field."); // DEBUG
        e.preventDefault();
        checkPassword();
      }
    });
  } else {
    console.error("Password input field (id: passwordInput) not found!"); // DEBUG
  }
  // æª¢æŸ¥ç™»å…¥æŒ‰éˆ•æ˜¯å¦å­˜åœ¨
  const loginButton = document.querySelector("button[onclick='checkPassword()']");
  if (loginButton) {
    console.log("Login button with onclick='checkPassword()' found."); // DEBUG
  } else {
    console.error("Login button with onclick='checkPassword()' NOT found."); // DEBUG
  }
});

/**
 * åˆå§‹åŒ–è¡¨å–®ï¼šè¨­å®šé è¨­æ—¥æœŸã€è¼‰å…¥ç´€éŒ„ç­‰
 */
function initializeForm() {
  console.log("initializeForm function called."); // DEBUG
  switchMode('CT'); // é è¨­ç‚º CT æ¨¡çµ„
  const now = new Date(Date.now() + 8 * 3600 * 1000); // ç²å–ç•¶å‰ UTC+8 æ™‚é–“
  const today = now.toISOString().split("T")[0]; // æ ¼å¼åŒ–ç‚º yyyy-MM-dd
  document.getElementById("todayBanner").textContent = today; // é¡¯ç¤ºä»Šæ—¥æ—¥æœŸ
  document.getElementById("date").value = today; // é è¨­æª¢æŸ¥æ—¥æœŸç‚ºä»Šæ—¥
  document.getElementById("dateFilter").value = today; // é è¨­ç¯©é¸æ—¥æœŸç‚ºä»Šæ—¥
  document.getElementById("sealDate").value = today; // é è¨­å°å°æ—¥æœŸç‚ºä»Šæ—¥

  // ç‚ºå°å°é¢æ¿çš„æ—¥æœŸé¸æ“‡æ¡†æ·»åŠ  change äº‹ä»¶ç›£è½å™¨
  const sealDateInput = document.getElementById("sealDate");
  if (sealDateInput) {
    sealDateInput.addEventListener("change", updateSealCheckboxesForSelectedDate);
    console.log("Event listener added to sealDate input."); // DEBUG
  } else {
    console.error("sealDate input not found for adding event listener."); // DEBUG
  }

  loadRecords(); // è¼‰å…¥é ç´„ç´€éŒ„
  cleanupOldRecords(); // æ¸…ç†èˆŠç´€éŒ„
  setupWebSocket(); // è¨­å®š WebSocket é€£ç·š
}


/**
 * æäº¤æ’ç¨‹è¡¨å–®
 */
function submitForm() {
  // ç²å–è¡¨å–®å„æ¬„ä½çš„å€¼
  const name = document.getElementById("name").value.trim();
  const chart = document.getElementById("chart").value.trim();
  const part = document.getElementById("part").value;
  const date = document.getElementById("date").value;
  const timeSlot = document.getElementById("time").value;
  const note = document.getElementById("note").value.trim();

  // åŸºæœ¬çš„è¡¨å–®é©—è­‰
  if (!name || !chart || part === "è«‹é¸æ“‡" || !part || !timeSlot || timeSlot === "è«‹é¸æ“‡" || !date) {
    return alert("è«‹å®Œæ•´å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ï¼ˆå§“åã€ç—…æ­·è™Ÿã€éƒ¨ä½ã€æ—¥æœŸã€æ™‚æ®µï¼‰ã€‚");
  }
  if (!/^\d{8}$/.test(chart)) { // é©—è­‰ç—…æ­·è™Ÿç‚º8ä½æ•¸å­—
    alert("ç—…æ­·è™Ÿç¢¼å¿…é ˆæ˜¯8ä½æ•¸å­—ï¼");
    document.getElementById("chart").focus();
    return;
  }

  // æª¢æŸ¥æ˜¯å¦èˆ‡å°å°æ™‚æ®µè¡çª (åƒ…é™ CT å’Œ MRI)
  const [hourString] = timeSlot.split(":");
  const hour = parseInt(hourString);
  const isAM = hour < 12; // åˆ¤æ–·æ˜¯å¦ç‚ºä¸Šåˆ

  if ((mode === "CT" || mode === "MRI") && currentModeActiveSeals[date]) {
    const sealStatus = currentModeActiveSeals[date];
    if ((isAM && sealStatus.am) || (!isAM && sealStatus.pm)) {
      return alert(`è©²æ—¥æœŸ (${date}) ${isAM ? 'ä¸Šåˆ' : 'ä¸‹åˆ'} æ™‚æ®µå·²å°å° (${mode})ï¼Œç„¡æ³•æ’æª¢ï¼`);
    }
  }

  const time = `${date} ${timeSlot}`; // çµ„åˆæ—¥æœŸèˆ‡æ™‚æ®µ
  // æº–å‚™å„²å­˜åˆ° Firebase çš„è³‡æ–™ç‰©ä»¶
  const record = { name, chart, part, time, note, createdAt: firebase.database.ServerValue.TIMESTAMP };

  // æ ¹æ“šç•¶å‰æ¨¡çµ„æ±ºå®š Firebase çš„å„²å­˜è·¯å¾‘
  let refPath = "appointments"; // CT é è¨­è·¯å¾‘
  if (mode === "BD") refPath = "bd_appointments";
  else if (mode === "IVP") refPath = "ivp_appointments";
  else if (mode === "MRI") refPath = "mri_appointments";

  // å°‡è³‡æ–™æ¨é€åˆ° Firebase
  db.ref(refPath).push(record, err => {
    if (!err) {
      alert("æ’ç¨‹å·²é€å‡º (" + mode + ")");
      // æ¸…ç©ºéƒ¨åˆ†è¡¨å–®æ¬„ä½
      ['name', 'chart', 'note'].forEach(id => document.getElementById(id).value = "");
      document.getElementById("part").value = (mode === "CT" || mode === "MRI") ? "" : "è«‹é¸æ“‡";
      document.getElementById("time").value = "";
      loadRecords(); // é‡æ–°è¼‰å…¥ç´€éŒ„
    } else {
      alert("é€å‡ºå¤±æ•—ï¼š" + err.message);
    }
  });
}

/**
 * å¾ Firebase è¼‰å…¥é ç´„ç´€éŒ„å’Œå°å°è³‡æ–™
 */
function loadRecords() {
  console.log(`loadRecords called for mode: ${mode}`); // DEBUG
  // æ ¹æ“šç•¶å‰æ¨¡çµ„æ±ºå®š Firebase çš„è®€å–è·¯å¾‘
  let appointmentRefPath = "appointments";
  if (mode === "BD") appointmentRefPath = "bd_appointments";
  else if (mode === "IVP") appointmentRefPath = "ivp_appointments";
  else if (mode === "MRI") appointmentRefPath = "mri_appointments";

  // è¼‰å…¥é ç´„ç´€éŒ„
  db.ref(appointmentRefPath).orderByChild("time").once("value", snap => {
    allData = []; // æ¸…ç©ºèˆŠè³‡æ–™
    snap.forEach(child => {
      const d = child.val();
      d.key = child.key; // åŠ å…¥ Firebase çš„ keyï¼Œæ–¹ä¾¿å¾ŒçºŒæ“ä½œ
      allData.push(d);
    });
    console.log(`Appointments loaded for ${mode}:`, allData.length); // DEBUG
    renderTable(); // æ¸²æŸ“é ç´„åˆ—è¡¨

    // è¼‰å…¥å°å°è³‡æ–™ (åƒ…é™ CT å’Œ MRI)
    let sealRefPathForMode = "";
    if (mode === "CT") sealRefPathForMode = "seals_ct";
    else if (mode === "MRI") sealRefPathForMode = "seals_mri";

    currentModeActiveSeals = {}; // é‡è¨­ç•¶å‰æ¨¡çµ„çš„å°å°è³‡æ–™
    if (sealRefPathForMode) {
      db.ref(sealRefPathForMode).once("value", sealSnap => {
        currentModeActiveSeals = sealSnap.val() || {};
        console.log(`Seals loaded for ${mode}:`, currentModeActiveSeals); // DEBUG
        updateSealSummary(); // æ›´æ–°å°å°ç¸½è¦½é¡¯ç¤º
        disableUsedTimeSlots(); // æ›´æ–°æ™‚æ®µä¸‹æ‹‰é¸å–®ç‹€æ…‹
        updateSealCheckboxesForSelectedDate(); // æ–°å¢ï¼šè¼‰å…¥å°å°å¾Œï¼ŒåŒæ­¥æ›´æ–°å‹¾é¸æ¡†ç‹€æ…‹
      });
    } else { // é CT/MRI æ¨¡çµ„ï¼Œæ¸…ç©ºå°å°ç¸½è¦½ä¸¦æ›´æ–°æ™‚æ®µç‹€æ…‹
      console.log(`No seals to load for mode: ${mode}`); // DEBUG
      updateSealSummary();
      disableUsedTimeSlots();
      updateSealCheckboxesForSelectedDate(); // æ–°å¢ï¼šç¢ºä¿é CT/MRI æ¨¡å¼ä¸‹å‹¾é¸æ¡†ä¹Ÿè¢«æ¸…ç©º
    }
  });
}

/**
 * æ¸²æŸ“é ç´„ç´€éŒ„è¡¨æ ¼
 */
function renderTable() {
  const q = document.getElementById("search").value.toLowerCase(); // ç²å–æœå°‹é—œéµå­—
  const filterDate = document.getElementById("dateFilter").value; // ç²å–ç¯©é¸æ—¥æœŸ
  const tbody = document.querySelector("#recordTable tbody");
  tbody.innerHTML = ""; // æ¸…ç©ºè¡¨æ ¼å…§å®¹

  // éæ¿¾ä¸¦æ’åºè³‡æ–™
  allData.filter(r => {
    const recordDateStr = (typeof r.time === "string") ? r.time.split(" ")[0] : "";
    const matchDate = !filterDate || recordDateStr === filterDate; // æ—¥æœŸç¯©é¸
    // é—œéµå­—ç¯©é¸ (å§“åã€ç—…æ­·è™Ÿã€éƒ¨ä½ã€æ™‚æ®µ)
    const matchesKeyword = !q || Object.values(r).some(v =>
      typeof v === "string" && v.toLowerCase().includes(q)
    );
    return matchDate && matchesKeyword;
  }).sort((a, b) => (a.time || "").localeCompare(b.time || "")).forEach(r => { // æŒ‰æ™‚é–“æ’åº
    let dateOnly = "â€”", timeOnly = "â€”";
    if (typeof r.time === "string") {
      const parts = r.time.split(" ");
      dateOnly = parts[0];
      timeOnly = parts.slice(1).join(" "); // è™•ç† "11:20 tumor" é€™é¡æ™‚æ®µ
    }
    // æ’å…¥è¡¨æ ¼è¡Œ
    const tr = tbody.insertRow();
    tr.innerHTML = `
      <td>${r.name}</td><td>${r.chart}</td><td>${r.part}</td>
      <td>${dateOnly}</td><td>${timeOnly}</td><td>${r.note || ""}</td>
      <td class="noprint"><button onclick="removeRecord('${r.key}')">åˆªé™¤</button></td>
    `;
  });
}

/**
 * å„²å­˜å°å°è¨­å®š (åƒ…é™ CT å’Œ MRI)
 */
function saveSeal() {
  const date = document.getElementById("sealDate").value;
  const am = document.getElementById("sealAM").checked; // ä¸Šåˆæ˜¯å¦å°å°
  const pm = document.getElementById("sealPM").checked; // ä¸‹åˆæ˜¯å¦å°å°
  if (!date) return alert("è«‹é¸æ“‡è¦å°å°çš„æ—¥æœŸ");
  if (mode !== "CT" && mode !== "MRI") return alert("åªæœ‰ CT å’Œ MRI æ¨¡å¼æ”¯æ´å°å°åŠŸèƒ½ã€‚");

  // æ ¹æ“šæ¨¡çµ„æ±ºå®š Firebase å„²å­˜è·¯å¾‘
  let sealRefPath = (mode === "CT" ? "seals_ct/" : "seals_mri/") + date;

  if (!am && !pm) { // å¦‚æœä¸Šä¸‹åˆéƒ½æœªå‹¾é¸ï¼Œå‰‡ç§»é™¤è©²æ—¥æœŸçš„å°å°è¨­å®š
    db.ref(sealRefPath).remove(() => {
      alert(`æ—¥æœŸ ${date} çš„ (${mode}) å°å°å·²å–æ¶ˆ`);
      loadRecords(); // é‡æ–°è¼‰å…¥ä»¥æ›´æ–°ç¸½è¦½å’Œæ™‚æ®µç‹€æ…‹
    });
  } else { // å„²å­˜å°å°è¨­å®š
    db.ref(sealRefPath).set({ am, pm }, () => {
      alert(`æ—¥æœŸ ${date} çš„ (${mode}) å°å°è¨­å®šå·²å„²å­˜`);
      loadRecords(); // é‡æ–°è¼‰å…¥
    });
  }
}

/**
 * ç”¢ç”Ÿåˆ—å°å ±è¡¨ (MRI ç¨ç«‹ï¼ŒCT/BD/IVP åˆä½µ)
 */
function generateCombinedPrint() {
  const area = document.getElementById("printCombinedArea");
  area.innerHTML = ""; // æ¸…ç©ºä¹‹å‰çš„åˆ—å°å…§å®¹
  const printDate = document.getElementById("dateFilter").value || document.getElementById("todayBanner").textContent; // ä½¿ç”¨ç¯©é¸æ—¥æœŸæˆ–ä»Šæ—¥æ—¥æœŸ

  let modesToPrint = [];
  let mainPrintTitle = "";

  if (mode === "MRI") { // å¦‚æœç•¶å‰æ˜¯ MRI æ¨¡å¼ï¼Œåªåˆ—å° MRI
    mainPrintTitle = `${printDate} MRI æ ¸ç£å…±æŒ¯ æª¢æŸ¥æ’ç¨‹`;
    modesToPrint = [
      { key: "MRI", path: "mri_appointments", name: "MRI æ ¸ç£å…±æŒ¯" }
    ];
  } else { // å¦å‰‡ (CT, BD, IVP æ¨¡å¼)ï¼Œåˆ—å°é€™ä¸‰è€…çš„åˆä½µå ±è¡¨
    mainPrintTitle = `${printDate} å„é …æª¢æŸ¥ç¸½è¡¨ (CT, BD, IVP)`;
    modesToPrint = [
      { key: "CT", path: "appointments", name: "CT é›»è…¦æ–·å±¤" },
      { key: "BD", path: "bd_appointments", name: "BD éª¨è³ªå¯†åº¦" },
      { key: "IVP", path: "ivp_appointments", name: "IVP éœè„ˆæ³¨å°„æ³Œå°¿æ”å½±" }
    ];
  }
  area.innerHTML = `<h2>${mainPrintTitle}</h2>`; // è¨­å®šåˆ—å°ä¸»æ¨™é¡Œ

  let results = [];
  let completedFetches = 0;

  // éæ­·éœ€è¦åˆ—å°çš„æ¨¡çµ„ï¼Œå¾ Firebase ç²å–è³‡æ–™
  modesToPrint.forEach(module => {
    db.ref(module.path).orderByChild("time").startAt(printDate).endAt(printDate + "\uf8ff").once("value", snap => {
      const records = [];
      snap.forEach(child => {
        const d = child.val();
        if (d.time && d.time.startsWith(printDate)) { // ç¢ºèªæ˜¯ç•¶æ—¥è³‡æ–™
          records.push(d);
        }
      });
      // æŒ‰æ™‚é–“æ’åºä¸¦åŠ å…¥çµæœé™£åˆ—
      results.push({ modeName: module.name, data: records.sort((a,b) => (a.time || "").localeCompare(b.time || "")) });
      completedFetches++;
      // æ‰€æœ‰æ¨¡çµ„è³‡æ–™ç²å–å®Œæˆå¾Œï¼Œæ¸²æŸ“åˆ—å°è¡¨æ ¼
      if (completedFetches === modesToPrint.length) {
        renderPrintTable(results, printDate);
      }
    });
  });
}

/**
 * æ¸²æŸ“å¯¦éš›çš„åˆ—å°è¡¨æ ¼å…§å®¹
 * @param {Array} allModulesData - åŒ…å«å„æ¨¡çµ„æ’ç¨‹è³‡æ–™çš„é™£åˆ—
 * @param {string} printDate - åˆ—å°çš„æ—¥æœŸ
 */
function renderPrintTable(allModulesData, printDate) {
  const area = document.getElementById("printCombinedArea");
  // ä¸»æ¨™é¡Œå·²åœ¨ generateCombinedPrint ä¸­è¨­å®š

  allModulesData.forEach(block => {
    if (block.data.length === 0) return; // å¦‚æœè©²æ¨¡çµ„ç„¡è³‡æ–™å‰‡è·³é

    // ç‚ºæ¯å€‹æ¨¡çµ„å»ºç«‹å­æ¨™é¡Œå’Œè¡¨æ ¼
    const h3 = document.createElement("h3");
    h3.textContent = `ğŸ“‹ ${block.modeName} æª¢æŸ¥æ’ç¨‹`;
    area.appendChild(h3);

    const table = document.createElement("table");
    table.innerHTML = "<thead><tr><th>å§“å</th><th>ç—…æ­·è™Ÿ</th><th>éƒ¨ä½</th><th>æ™‚æ®µ</th><th>å‚™è¨»</th></tr></thead>";
    const tbody = document.createElement("tbody");

    block.data.forEach(r => { // éæ­·è©²æ¨¡çµ„çš„æ¯ç­†ç´€éŒ„
      const tr = document.createElement("tr");
      const timeOnly = r.time ? r.time.split(" ").slice(1).join(" ") : "â€”"; // æå–æ™‚æ®µéƒ¨åˆ†
      tr.innerHTML = [
        r.name || "â€”", r.chart || "â€”", r.part || "â€”",
        timeOnly, r.note || ""
      ].map(txt => `<td style='border:1px solid #ccc; padding:4px;'>${txt}</td>`).join("");
      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    area.appendChild(table);
    area.appendChild(document.createElement("br")); // æ¨¡çµ„é–“éš”
  });
  area.style.display = "block"; // é¡¯ç¤ºåˆ—å°å€åŸŸ

  // è¨­å®šåˆ—å°å¾Œæ¸…é™¤åˆ—å°å€åŸŸçš„äº‹ä»¶
  const clearPrintArea = () => {
    area.innerHTML = "";
    area.style.display = "none";
    window.removeEventListener("afterprint", clearPrintArea);
  };
  window.addEventListener("afterprint", clearPrintArea);

  window.print(); // è§¸ç™¼ç€è¦½å™¨åˆ—å°

  // åˆ—å°å°è©±æ¡†é—œé–‰å¾Œçš„å»¶é²æ¸…é™¤ (å‚™ç”¨)
  setTimeout(() => {
    if (area.style.display === "block") {
        clearPrintArea();
    }
  }, 3000);
}

/**
 * æ¨¡æ“¬è®€å¡åŠŸèƒ½ (ç¯„ä¾‹)
 */
function simulateCardRead() {
  const nameToSimulate = "ç‹å°æ˜";
  document.getElementById("name").value = nameToSimulate; // è‡ªå‹•å¡«å…¥å§“å
  const currentMonthKey = new Date().toISOString().slice(0, 7); // ç•¶å‰æœˆä»½ yyyy-MM

  // éœ€è¦æŸ¥è©¢çš„æ¨¡çµ„è·¯å¾‘å’Œåç¨±
  const lookupModules = [
      { path: "appointments", name: "CT" },
      { path: "mri_appointments", name: "MRI" },
      { path: "bd_appointments", name: "BD" },
      { path: "ivp_appointments", name: "IVP" }
  ];
  let resultText = "";
  let foundOverall = false;
  let checkedModules = 0;

  document.getElementById("lookupResult").innerHTML = "æŸ¥è©¢ä¸­..."; // é¡¯ç¤ºæŸ¥è©¢ç‹€æ…‹

  // éæ­·å„æ¨¡çµ„æŸ¥è©¢è©²ç—…æ‚£æœ¬æœˆæ˜¯å¦æœ‰æ’ç¨‹
  lookupModules.forEach(module => {
    db.ref(module.path).orderByChild("name").equalTo(nameToSimulate).once("value", snap => {
      snap.forEach(child => {
        const d = child.val();
        if (d.time && d.time.startsWith(currentMonthKey)) { // æª¢æŸ¥æ˜¯å¦ç‚ºæœ¬æœˆç´€éŒ„
          const timePart = d.time.split(" ")[1];
          resultText += `ğŸ“ ${module.name}ï¼š${d.time.split(" ")[0]} ${timePart} ${d.part}<br>`;
          foundOverall = true;
        }
      });
      checkedModules++;
      // æ‰€æœ‰æ¨¡çµ„æŸ¥è©¢å®Œç•¢å¾Œæ›´æ–°çµæœ
      if (checkedModules === lookupModules.length) {
        if (!foundOverall) resultText = `âŒ æœ¬æœˆæœªæ‰¾åˆ° ${nameToSimulate} çš„æ’ç¨‹è³‡æ–™`;
        document.getElementById("lookupResult").innerHTML = resultText;
      }
    });
  });
}

/**
 * è¨­å®š WebSocket é€£ç·š (ç”¨æ–¼æ¥æ”¶åˆ·å¡è³‡æ–™ç­‰)
 */
function setupWebSocket() {
  try {
    const socket = new WebSocket("ws://localhost:8765"); // WebSocket ä¼ºæœå™¨ä½å€
    socket.onopen = function() { console.log("WebSocket é€£ç·šæˆåŠŸ"); };
    socket.onmessage = function (event) { // æ”¶åˆ°è¨Šæ¯æ™‚
      try {
        const data = JSON.parse(event.data); // è§£æ JSON è³‡æ–™
        if (data.name) { // å¦‚æœæœ‰å§“åè³‡æ–™
          document.getElementById("name").value = data.name; // è‡ªå‹•å¡«å…¥å§“å
          // ä»¥ä¸‹é‚è¼¯åŒ simulateCardReadï¼Œç”¨æ–¼æŸ¥è©¢è©²ç—…æ‚£çš„æ’ç¨‹
          const currentMonthKey = new Date().toISOString().slice(0, 7);
          const lookupModules = [
            { path: "appointments", name: "CT" }, { path: "mri_appointments", name: "MRI" },
            { path: "bd_appointments", name: "BD" }, { path: "ivp_appointments", name: "IVP" }
          ];
          let resultText = "";
          let foundOverall = false;
          let checkedModules = 0;
          document.getElementById("lookupResult").innerHTML = "è®€å¡æŸ¥è©¢ä¸­...";

          lookupModules.forEach(module => {
            db.ref(module.path).orderByChild("name").equalTo(data.name).once("value", snap => {
              snap.forEach(child => {
                const d = child.val();
                if (d.time && d.time.startsWith(currentMonthKey)) {
                  const timePart = d.time.split(" ")[1];
                  resultText += `ğŸ“ ${module.name}ï¼š${d.time.split(" ")[0]} ${timePart} ${d.part}<br>`;
                  foundOverall = true;
                }
              });
              checkedModules++;
              if (checkedModules === lookupModules.length) {
                if (!foundOverall) resultText = `âŒ æœ¬æœˆæœªæ‰¾åˆ° ${data.name} çš„æ’ç¨‹è³‡æ–™`;
                document.getElementById("lookupResult").innerHTML = resultText;
              }
            });
          });
        }
      } catch (e) {
        console.error("è™•ç† WebSocket è¨Šæ¯éŒ¯èª¤ï¼š", e);
        document.getElementById("lookupResult").innerHTML = "è™•ç†è®€å¡è³‡æ–™éŒ¯èª¤";
      }
    };
    socket.onerror = function(error) { console.error("WebSocket éŒ¯èª¤ï¼š", error); document.getElementById("lookupResult").innerHTML = "WebSocket é€£ç·šéŒ¯èª¤"; };
    socket.onclose = function() { console.log("WebSocket é€£ç·šé—œé–‰"); document.getElementById("lookupResult").innerHTML = "WebSocket é€£ç·šå·²é—œé–‰"; };
  } catch (e) {
    console.error("å»ºç«‹ WebSocket é€£ç·šå¤±æ•—ï¼š", e);
    document.getElementById("lookupResult").innerHTML = "ç„¡æ³•å»ºç«‹ WebSocket é€£ç·š";
  }
}

/**
 * åˆªé™¤æŒ‡å®šçš„é ç´„ç´€éŒ„
 * @param {string} key - Firebase ä¸­è©²ç­†ç´€éŒ„çš„ Key
 */
function removeRecord(key) {
  if (confirm("ç¢ºå®šåˆªé™¤æ­¤ç­†é ç´„ç´€éŒ„ï¼Ÿ")) {
    // æ ¹æ“šç•¶å‰æ¨¡çµ„æ±ºå®š Firebase çš„åˆªé™¤è·¯å¾‘
    let refPath = "appointments";
    if (mode === "BD") refPath = "bd_appointments";
    else if (mode === "IVP") refPath = "ivp_appointments";
    else if (mode === "MRI") refPath = "mri_appointments";

    db.ref(refPath + "/" + key).remove(err => {
        if (!err) {
            alert("ç´€éŒ„å·²åˆªé™¤");
            loadRecords(); // é‡æ–°è¼‰å…¥ç´€éŒ„
        } else {
            alert("åˆªé™¤å¤±æ•—ï¼š" + err.message);
        }
    });
  }
}
</script>
</body>
</html>
