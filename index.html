<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>æª¢æŸ¥æ’ç¨‹è¡¨å–®</title>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<style>
    option.used-slot{color:red !important; font-weight:bold;}
    option.sealed-slot { color: #007bff !important; font-style: italic; }
    body { font-family: sans-serif; max-width: 1200px; margin: auto; padding: 20px; display: flex; flex-direction: column; }
    input, select, button, textarea {
      display: block; width: 100%; margin: 10px 0; padding: 8px; font-size: 16px;
    }
    button { background-color: #4CAF50; color: white; border: none; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    th { background: #f0f0f0; }
    @media print { .noprint { display: none !important; } }
    #sealPanel { float: right; border: 1px solid #ccc; padding: 10px; margin-left: 20px; width: 280px; background: #f9f9f9; }
    #formSection { flex: 1; max-width: 800px; }

    body {
      font-family: "Segoe UI", "Noto Sans TC", sans-serif;
      background: url('8c829460-d144-11e9-8e6f-74942275b45f.jpg') no-repeat center center fixed;
      background-size: cover;
      backdrop-filter: blur(4px);
      color: #333;
    }
    input, select, button, textarea {
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    button {
      background-color: #ffd1dc;
      color: black;
      transition: 0.3s ease;
    }
    button:hover {
      background-color: #f48fb1;
    }
    table {
      background: rgba(255,255,255,0.95);
    }
    th {
      background: #ffe4ec;
      color: #880e4f;
    }
    #sealPanel {
      background: rgba(255,255,255,0.85);
    }

    #sealPanel label.seal-option {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
    }
    #sealPanel label.seal-option input[type="checkbox"] {
        width: auto;
        margin-right: 8px;
        margin-top: 0;
        margin-bottom: 0;
    }

    @media print {
      body * {
        visibility: hidden !important;
      }
      #printCombinedArea, #printCombinedArea * {
        visibility: visible !important;
      }
      #printCombinedArea {
        position: absolute;
        top: 0;
        left: 0;
        width: 90%;
        margin: 20px auto;
        background: white;
        padding: 15px;
        font-size: 12px;
        box-shadow: 0 0 10px rgba(0,0,0,0.2);
      }
      #printCombinedArea table {
        font-size: 11px;
        width: 100%;
        margin: auto;
        border-collapse: collapse;
      }
      #printCombinedArea th, #printCombinedArea td {
        border: 1px solid #ccc;
        padding: 3px;
      }
      #printCombinedArea h3 {
        font-size: 16px;
      }
    }

    table th:nth-child(1), /* Name */
    table td:nth-child(1) {
      width: 100px;
    }
    table th:nth-child(2), /* Chart */
    table td:nth-child(2) {
      width: 80px;
    }
     table th:nth-child(3), /* Part */
    table td:nth-child(3) {
      width: auto; 
    }
    table th:nth-child(4), /* Date (in list) */
    table td:nth-child(4) {
      width: 90px;
    }
    table th:nth-child(5), /* Time (in list) */
    table td:nth-child(5) {
      width: 120px;
    }

    #recordTable th, #recordTable td {
      color: #000 !important;
    }
</style>
</head>
<body>

<div id="loginForm">
<h3>ğŸ”’ è«‹è¼¸å…¥å¯†ç¢¼é€²å…¥ç³»çµ±</h3>
<input id="passwordInput" placeholder="è¼¸å…¥å¯†ç¢¼" type="password"/>
<button onclick="checkPassword()">ç™»å…¥</button>
</div>

<div id="protected" style="display:none;">
  <div style="display: flex; justify-content: space-between; align-items: flex-start;">
    <div id="formSection">
      <div class="noprint" style="margin-bottom:10px;"><img src="logo.png" style="height:60px;" alt="é™¢æ‰€Logo"></div>
      <h2>æª¢æŸ¥æ’ç¨‹è¡¨å–®ï¼ˆ<span id="modeTitle">CT</span> æ¨¡çµ„ï¼‰</h2>
      <div style="margin-bottom:10px;">
        <button onclick="switchMode('CT')">åˆ‡æ›ç‚º CT</button>
        <button onclick="switchMode('MRI')">åˆ‡æ›ç‚º MRI</button>
        <button onclick="switchMode('BD')">åˆ‡æ›ç‚º BD</button>
        <button onclick="switchMode('IVP')">åˆ‡æ›ç‚º IVP</button>
      </div>
      <div>ğŸ“… ä»Šæ—¥æ—¥æœŸï¼š<span id="todayBanner"></span></div>
      <div id="lookupResult" style="font-weight:bold; margin-top:10px; margin-bottom:10px; min-height: 20px;">è«‹åˆ·ICå¡ã€æƒææˆ–è¼¸å…¥ç—…æ­·è™Ÿå¾ŒæŒ‰ Enterã€‚</div>
      <label>ç—…äººå§“åï¼š<input id="name"/></label>
      <label>ç—…æ­·è™Ÿï¼š<input id="chart" onkeypress="if(event.key === 'Enter'){ event.preventDefault(); handleChartNumberEntry(); }"/></label>
      <label>æª¢æŸ¥éƒ¨ä½ï¼š
        <input id="part" list="ctPartsList" placeholder="è«‹è¼¸å…¥æˆ–é¸æ“‡éƒ¨ä½">
        <datalist id="ctPartsList">
          <option value="å¿ƒè‡Ÿéˆ£åŒ–é›»è…¦æ–·å±¤æ”å½± Calcification(ä¸æ‰“è—¥)">
          <option value="å¿ƒè‡Ÿé›»è…¦æ–·å±¤è¡€ç®¡æ”å½±å¥—çµ„ HEART CTA+Calcification(æ‰“è—¥)">
          <option value="é ­éƒ¨ brain(æ‰“è—¥)">
          <option value="é ­éƒ¨ brain(ä¸æ‰“è—¥)">
          <option value="é ¸éƒ¨ neck(æ‰“è—¥)">
          <option value="é ¸éƒ¨ neck(ä¸æ‰“è—¥)">
          <option value="é ¸æ¤ c-spine(æ‰“è—¥)">
          <option value="é ¸æ¤ c-spine(ä¸æ‰“è—¥)">
          <option value="èƒ¸éƒ¨ chest(æ‰“è—¥)">
          <option value="èƒ¸éƒ¨ chest(ä¸æ‰“è—¥)">
          <option value="ä½è¼»å°„åŠ‘é‡è‚ºéƒ¨ç¯©æª¢ Low dose lung screen(ä¸æ‰“è—¥)">
          <option value="é«˜è§£æè‚ºéƒ¨ HRCT(ä¸æ‰“è—¥)">
          <option value="è…¹éƒ¨ Abdomen+PELVIS(æ‰“è—¥)">
          <option value="è…¹éƒ¨ Abdomen+PELVIS(ä¸æ‰“è—¥)">
          <option value="è…°æ¤ L-spine(æ‰“è—¥)">
          <option value="è…°æ¤ L-spine(ä¸æ‰“è—¥)">
          <option value="èƒ¸æ¤ T-spine(æ‰“è—¥)">
          <option value="èƒ¸æ¤ T-spine(ä¸æ‰“è—¥)">
          <option value="4è‚¢ Limbs(æ‰“è—¥)">
          <option value="4è‚¢ Limbs(ä¸æ‰“è—¥)">
        </datalist>
      </label>
      <label>æª¢æŸ¥æ—¥æœŸï¼š<input id="date" onchange="disableUsedTimeSlots()" type="date"/></label>
      <label>æª¢æŸ¥æ™‚æ®µï¼š
        <select id="time"></select>
      </label>
      <label>å‚™è¨»ï¼š<textarea id="note"></textarea></label>
      <button onclick="submitForm()">é€å‡ºæ’ç¨‹</button>
      <h3>ğŸ“‹ å·²é ç´„æ¸…å–®</h3>
      <label>ç¯©é¸æ—¥æœŸï¼š<input id="dateFilter" onchange="renderTable()" type="date"/></label>
      <input id="search" oninput="renderTable()" placeholder="æœå°‹å§“åã€ç—…æ­·è™Ÿã€éƒ¨ä½æˆ–æ™‚æ®µ..."/>
      <button onclick="loadRecords()">è¼‰å…¥é ç´„ç´€éŒ„</button>
      <button onclick="generateCombinedPrint()">ç”¢å‡ºåˆ—å°ç¸½è¡¨</button>
      <table id="recordTable">
        <thead><tr><th>å§“å</th><th>ç—…æ­·è™Ÿ</th><th>éƒ¨ä½</th><th>æ—¥æœŸ</th><th>æ™‚æ®µ</th><th>å‚™è¨»</th><th class="noprint">æ“ä½œ</th></tr></thead>
        <tbody></tbody>
      </table>
      <div id="printCombinedArea" style="display:none; margin-top:30px;"></div>
    </div>

    <div id="sealPanel" style="display:none;">
      <h4>ğŸ“Œ å°å°æ’æª¢æ™‚æ®µç®¡ç† (<span id="sealModeTitle">CT</span>)</h4>
      <label>é¸æ“‡æ—¥æœŸï¼š<input id="sealDate" type="date"/></label>
      <label class="seal-option"><input id="sealAM" type="checkbox"/><span>å°å°ä¸Šåˆ</span></label>
      <label class="seal-option"><input id="sealPM" type="checkbox"/><span>å°å°ä¸‹åˆ</span></label>
      <button onclick="saveSeal()">å„²å­˜å°å°è¨­å®š</button>
      <div style="margin-top: 20px;">
        <h4>ğŸ“‹ <span id="sealSummaryTitle">CT</span> å°å°ç¸½è¦½</h4>
        <ul id="sealSummaryList" style="padding-left: 20px; max-height: 200px; overflow-y: auto;"></ul>
      </div>
    </div>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBLgUdGaDarOAQF_5YGo4df6KyU8DsclA0", // è«‹æ›¿æ›æˆæ‚¨è‡ªå·±çš„ Firebase API Key
  authDomain: "ct-reserve.firebaseapp.com", // è«‹æ›¿æ›æˆæ‚¨è‡ªå·±çš„ Firebase Auth Domain
  databaseURL: "https://ct-reserve-default-rtdb.firebaseio.com", // è«‹æ›¿æ›æˆæ‚¨è‡ªå·±çš„ Firebase Database URL
  projectId: "ct-reserve", // è«‹æ›¿æ›æˆæ‚¨è‡ªå·±çš„ Firebase Project ID
  storageBucket: "ct-reserve.appspot.com", // è«‹æ›¿æ›æˆæ‚¨è‡ªå·±çš„ Firebase Storage Bucket
  messagingSenderId: "263734590112", // è«‹æ›¿æ›æˆæ‚¨è‡ªå·±çš„ Firebase Messaging Sender ID
  appId: "1:263734590112:web:34fec465ce56d91f68a7c5" // è«‹æ›¿æ›æˆæ‚¨è‡ªå·±çš„ Firebase App ID
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let mode = 'CT'; 
let allData = []; 
let currentModeActiveSeals = {}; 

const ctParts = [
  "è«‹é¸æ“‡", "å¿ƒè‡Ÿéˆ£åŒ–é›»è…¦æ–·å±¤æ”å½± Calcification(ä¸æ‰“è—¥)", "å¿ƒè‡Ÿé›»è…¦æ–·å±¤è¡€ç®¡æ”å½±å¥—çµ„ HEART CTA+Calcification(æ‰“è—¥)",
  "é ­éƒ¨ brain(æ‰“è—¥)", "é ­éƒ¨ brain(ä¸æ‰“è—¥)", "é ¸éƒ¨ neck(æ‰“è—¥)", "é ¸éƒ¨ neck(ä¸æ‰“è—¥)",
  "é ¸æ¤ c-spine(æ‰“è—¥)", "é ¸æ¤ c-spine(ä¸æ‰“è—¥)", "èƒ¸éƒ¨ chest(æ‰“è—¥)", "èƒ¸éƒ¨ chest(ä¸æ‰“è—¥)",
  "ä½è¼»å°„åŠ‘é‡è‚ºéƒ¨ç¯©æª¢ Low dose lung screen(ä¸æ‰“è—¥)", "é«˜è§£æè‚ºéƒ¨ HRCT(ä¸æ‰“è—¥)",
  "è…¹éƒ¨ Abdomen+PELVIS(æ‰“è—¥)", "è…¹éƒ¨ Abdomen+PELVIS(ä¸æ‰“è—¥)", "è…°æ¤ L-spine(æ‰“è—¥)", "è…°æ¤ L-spine(ä¸æ‰“è—¥)",
  "èƒ¸æ¤ T-spine(æ‰“è—¥)", "èƒ¸æ¤ T-spine(ä¸æ‰“è—¥)", "4è‚¢ Limbs(æ‰“è—¥)", "4è‚¢ Limbs(ä¸æ‰“è—¥)"
];
const bdParts = [ "è«‹é¸æ“‡", "è…°æ¤éª¨è³ªå¯†åº¦(L-SPINE)", "å…©å´é«–é—œç¯€éª¨è³ªå¯†åº¦(Bilateral HIP)", "è…°æ¤éª¨è³ªå¯†åº¦(L-SPINE) + å…©å´é«–é—œç¯€éª¨è³ªå¯†åº¦(Bilateral HIP)", "è…°æ¤å´ä½éª¨è³ªå¯†åº¦(L-SPINE Lateral)" ];
const ivpParts = [ "è«‹é¸æ“‡", "éœè„ˆæ³¨å°„æ³Œå°¿ç³»çµ±æ”å½±æª¢æŸ¥(IVP)" ];
const mriParts = [ 
  "è«‹é¸æ“‡", "MRI é ­éƒ¨ Brain (ä¸æ‰“è—¥)", "MRI é ­éƒ¨ Brain (æ‰“è—¥)", "MRI é ¸æ¤ C-spine (ä¸æ‰“è—¥)",
  "MRI èƒ¸æ¤ T-spine (ä¸æ‰“è—¥)", "MRI è…°æ¤ L-spine (ä¸æ‰“è—¥)", "MRI éª¨ç›† Pelvis (ä¸æ‰“è—¥)",
  "MRI è‚©é—œç¯€ Shoulder (ä¸æ‰“è—¥)", "MRI è‚˜é—œç¯€ Elbow (ä¸æ‰“è—¥)", "MRI è…•é—œç¯€ Wrist (ä¸æ‰“è—¥)",
  "MRI é«–é—œç¯€ Hip (ä¸æ‰“è—¥)", "MRI è†é—œç¯€ Knee (ä¸æ‰“è—¥)", "MRI è¸é—œç¯€ Ankle (ä¸æ‰“è—¥)",
  "MRI ä¹³æˆ¿ Breast (æ‰“è—¥)"
];

function getCurrentAppointmentPath() {
    let path = "appointments"; 
    if (mode === "BD") path = "bd_appointments";
    else if (mode === "IVP") path = "ivp_appointments";
    else if (mode === "MRI") path = "mri_appointments";
    return path;
}

function switchMode(newMode) {
  mode = newMode;
  document.getElementById("modeTitle").textContent = mode; 
  document.getElementById("sealModeTitle").textContent = mode; 
  document.getElementById("sealSummaryTitle").textContent = mode; 
  document.getElementById("sealPanel").style.display = (mode === "CT" || mode === "MRI") ? "block" : "none";

  const partContainer = document.getElementById("part").parentElement; 
  let partInputHtml = ''; 

  if (mode === "CT") {
    partInputHtml = `<input id="part" list="ctPartsDataList" placeholder="è«‹è¼¸å…¥æˆ–é¸æ“‡CTéƒ¨ä½">
                     <datalist id="ctPartsDataList">${ctParts.slice(1).map(p => `<option value="${p}">`).join('')}</datalist>`;
  } else if (mode === "MRI") {
    partInputHtml = `<input id="part" list="mriPartsDataList" placeholder="è«‹è¼¸å…¥æˆ–é¸æ“‡MRIéƒ¨ä½">
                     <datalist id="mriPartsDataList">${mriParts.slice(1).map(p => `<option value="${p}">`).join('')}</datalist>`;
  } else { 
    const partsList = mode === "BD" ? bdParts : ivpParts;
    const partSelect = document.createElement("select");
    partSelect.id = "part";
    partSelect.innerHTML = partsList.map(p => `<option value="${p}">${p}</option>`).join('');
    partContainer.innerHTML = "æª¢æŸ¥éƒ¨ä½ï¼š<br>"; 
    partContainer.appendChild(partSelect);
  }

  if (mode === "CT" || mode === "MRI") {
      partContainer.innerHTML = `æª¢æŸ¥éƒ¨ä½ï¼š<br>${partInputHtml}`;
  }

  const timeSelect = document.getElementById("time");
  let timeOptions = ['<option value="">è«‹é¸æ“‡</option>']; 
  if (mode === "CT") {
    timeOptions.push(
      '<option value="(HEART CTA+éˆ£åŒ–åˆ†æ)1">(HEART CTA+éˆ£åŒ–åˆ†æ)1</option>',
      '<option value="(HEART CTA+éˆ£åŒ–åˆ†æ)2">(HEART CTA+éˆ£åŒ–åˆ†æ)2</option>',
      '08:00', '08:20', '08:40', '09:00', '09:20', '09:40', '10:00', '10:20', '10:40',
      '11:00', '11:20 tumor', '11:40 ç—…æˆ¿', '13:20', '13:40', '14:00', '14:20',
      '14:40', '15:00', '15:20', '15:40', '16:00 ç—…æˆ¿'
    );
  } else if (mode === "MRI") { 
    timeOptions.push(
      '08:00', '08:30', '09:00', '09:30', '10:00', '10:30', '11:00', '11:30',
      '13:30', '14:00', '14:30', '15:00', '15:30', '16:00', '16:30'
    );
  } else { 
    timeOptions.push(
      '08:00', '08:20', '08:40', '09:00', '09:20', '09:40', '10:00', '10:20', '10:40',
      '11:00', '11:20 tumor', '11:40 ç—…æˆ¿', '13:20', '13:40', '14:00', '14:20',
      '14:40', '15:00', '15:20', '15:40', '16:00 ç—…æˆ¿'
    );
  }
  timeSelect.innerHTML = timeOptions.map(t => t.startsWith('<opt') ? t : `<option value="${t}">${t}</option>`).join('');

  Array.from(timeSelect.options).forEach(function(opt) {
    if (opt.text.includes("(HEART CTA+éˆ£åŒ–åˆ†æ)")) {
      opt.style.color = 'green';
      opt.style.fontWeight = 'bold';
    }
  });

  document.getElementById("part").value = ""; 
  document.getElementById("time").value = ""; 
  loadRecords(); 
}

function cleanupOldRecords() {
  const today = new Date();
  const cutoff = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate()); 

  const appointmentPaths = ["appointments", "bd_appointments", "ivp_appointments", "mri_appointments"];
  appointmentPaths.forEach(path => {
    db.ref(path).orderByChild("createdAt").endAt(cutoff.getTime()).once("value", snap => {
      snap.forEach(child => {
         db.ref(path + "/" + child.key).remove();
      });
    });
  });

  const sealPaths = ["seals_ct", "seals_mri"];
  sealPaths.forEach(path => {
    db.ref(path).once("value", snap => {
      snap.forEach(child => {
        const sealDate = new Date(child.key); 
        if (sealDate < cutoff) {
          db.ref(path + "/" + child.key).remove();
        }
      });
    });
  });
}

function disableUsedTimeSlots() {
  const selectedDate = document.getElementById("date").value; 
  const timeSelect = document.getElementById("time"); 

  Array.from(timeSelect.options).forEach(opt => {
    opt.disabled = false; 
    opt.style.display = ''; 
    opt.classList.remove("used-slot", "sealed-slot"); 
    opt.style.color = ''; 
    opt.style.fontWeight = ''; 
    opt.style.fontStyle = ''; 
    if (opt.text.includes("(HEART CTA+éˆ£åŒ–åˆ†æ)")) {
        opt.style.color = 'green';
        opt.style.fontWeight = 'bold';
    }
  });

  if (!selectedDate) return; 

  const usedTimesOnSelectedDate = allData
    .filter(r => typeof r.time === "string" && r.time.startsWith(selectedDate))
    .map(r => {
        const parts = r.time.split(" ");
        return parts.slice(1).join(" "); 
    });

  const dateSeals = (mode === "CT" || mode === "MRI") ? currentModeActiveSeals[selectedDate] : null;

  Array.from(timeSelect.options).forEach(opt => {
    if (!opt.value || opt.value === "è«‹é¸æ“‡") return; 

    let isHidden = false; 

    if (usedTimesOnSelectedDate.includes(opt.value)) {
      opt.style.display = 'none'; 
      isHidden = true;
    }

    if (!isHidden && dateSeals) {
      const [hourStr] = opt.value.split(":"); 
      if (hourStr && !isNaN(parseInt(hourStr))) {
        const hour = parseInt(hourStr);
        let slotIsSealed = false; 
        if (hour < 12 && dateSeals.am) slotIsSealed = true; 
        if (hour >= 12 && dateSeals.pm) slotIsSealed = true; 

        if (slotIsSealed) {
          opt.classList.add("sealed-slot"); 
          opt.disabled = true; 
        }
      }
    }
  });
}

function updateSealSummary() {
  const list = document.getElementById("sealSummaryList");
  list.innerHTML = ""; 
  document.getElementById("sealSummaryTitle").textContent = mode; 

  if (mode !== "CT" && mode !== "MRI") return;

  Object.keys(currentModeActiveSeals).sort().forEach(date => {
    const s = currentModeActiveSeals[date];
    if (s.am || s.pm) { 
      const label = `${date}ï¼š${s.am ? "ä¸Šåˆå°å°" : ""}${s.am && s.pm ? "ã€" : ""}${s.pm ? "ä¸‹åˆå°å°" : ""}`;
      const li = document.createElement("li");
      li.textContent = label;
      list.appendChild(li);
    }
  });
}

function updateSealCheckboxesForSelectedDate() {
  const selectedSealDate = document.getElementById("sealDate").value;
  const sealAMCheckbox = document.getElementById("sealAM");
  const sealPMCheckbox = document.getElementById("sealPM");

  if (!selectedSealDate || (mode !== "CT" && mode !== "MRI")) {
    sealAMCheckbox.checked = false;
    sealPMCheckbox.checked = false;
    return;
  }

  const sealsForDate = currentModeActiveSeals[selectedSealDate];

  if (sealsForDate) { 
    sealAMCheckbox.checked = sealsForDate.am || false; 
    sealPMCheckbox.checked = sealsForDate.pm || false; 
  } else { 
    sealAMCheckbox.checked = false;
    sealPMCheckbox.checked = false;
  }
}

function checkPassword() {
  const passwordInputValue = document.getElementById("passwordInput").value;
  if (passwordInputValue === "km1234") {
    document.getElementById("protected").style.display = "block";
    document.getElementById("loginForm").style.display = "none";
    initializeForm();
  } else {
    alert("å¯†ç¢¼éŒ¯èª¤");
  }
}

document.addEventListener("DOMContentLoaded", () => {
  const passwordInputEl = document.getElementById("passwordInput");
  if (passwordInputEl) {
    passwordInputEl.addEventListener("keypress", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        checkPassword();
      }
    });
  }
});

function initializeForm() {
  switchMode('CT'); 
  const now = new Date(Date.now() + 8 * 3600 * 1000); 
  const today = now.toISOString().split("T")[0]; 
  document.getElementById("todayBanner").textContent = today; 
  document.getElementById("date").value = today; 
  document.getElementById("dateFilter").value = today; 
  document.getElementById("sealDate").value = today; 

  const sealDateInput = document.getElementById("sealDate");
  if (sealDateInput) {
    sealDateInput.addEventListener("change", updateSealCheckboxesForSelectedDate);
  }

  loadRecords(); 
  cleanupOldRecords(); 
  setupGlobalScannerListener(); // æƒç¢¼æ©Ÿçš„å…¨åŸŸç›£è½
  setupWebSocket(); // ICå¡è®€å¡æ©Ÿçš„ WebSocket é€£ç·š
}

function submitForm() {
  const name = document.getElementById("name").value.trim();
  const chart = document.getElementById("chart").value.trim();
  const part = document.getElementById("part").value;
  const date = document.getElementById("date").value;
  const timeSlot = document.getElementById("time").value;
  const note = document.getElementById("note").value.trim();

  if (!name || !chart || part === "è«‹é¸æ“‡" || !part || !timeSlot || timeSlot === "è«‹é¸æ“‡" || !date) {
    return alert("è«‹å®Œæ•´å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ï¼ˆå§“åã€ç—…æ­·è™Ÿã€éƒ¨ä½ã€æ—¥æœŸã€æ™‚æ®µï¼‰ã€‚");
  }
  if (!/^\d{8}$/.test(chart)) { 
    alert("ç—…æ­·è™Ÿç¢¼å¿…é ˆæ˜¯8ä½æ•¸å­—ï¼");
    document.getElementById("chart").focus();
    return;
  }

  const [hourString] = timeSlot.split(":");
  const hour = parseInt(hourString);
  const isAM = hour < 12; 

  if ((mode === "CT" || mode === "MRI") && currentModeActiveSeals[date]) {
    const sealStatus = currentModeActiveSeals[date];
    if ((isAM && sealStatus.am) || (!isAM && sealStatus.pm)) {
      return alert(`è©²æ—¥æœŸ (${date}) ${isAM ? 'ä¸Šåˆ' : 'ä¸‹åˆ'} æ™‚æ®µå·²å°å° (${mode})ï¼Œç„¡æ³•æ’æª¢ï¼`);
    }
  }

  const time = `${date} ${timeSlot}`; 
  const record = { name, chart, part, time, note, createdAt: firebase.database.ServerValue.TIMESTAMP };

  db.ref(getCurrentAppointmentPath()).push(record, err => {
    if (!err) {
      alert("æ’ç¨‹å·²é€å‡º (" + mode + ")");
      ['name', 'chart', 'note'].forEach(id => document.getElementById(id).value = "");
      document.getElementById("part").value = (mode === "CT" || mode === "MRI") ? "" : "è«‹é¸æ“‡";
      document.getElementById("time").value = "";
      loadRecords(); 
    } else {
      alert("é€å‡ºå¤±æ•—ï¼š" + err.message);
    }
  });
}

function loadRecords() {
  db.ref(getCurrentAppointmentPath()).orderByChild("time").once("value", snap => {
    allData = []; 
    snap.forEach(child => {
      const d = child.val();
      d.key = child.key; 
      allData.push(d);
    });
    renderTable(); 

    let sealRefPathForMode = "";
    if (mode === "CT") sealRefPathForMode = "seals_ct";
    else if (mode === "MRI") sealRefPathForMode = "seals_mri";

    currentModeActiveSeals = {}; 
    if (sealRefPathForMode) {
      db.ref(sealRefPathForMode).once("value", sealSnap => {
        currentModeActiveSeals = sealSnap.val() || {};
        updateSealSummary(); 
        disableUsedTimeSlots(); 
        updateSealCheckboxesForSelectedDate(); 
      });
    } else { 
      updateSealSummary();
      disableUsedTimeSlots();
      updateSealCheckboxesForSelectedDate(); 
    }
  });
}

function renderTable() {
  const q = document.getElementById("search").value.toLowerCase(); 
  const filterDate = document.getElementById("dateFilter").value; 
  const tbody = document.querySelector("#recordTable tbody");
  tbody.innerHTML = ""; 

  allData.filter(r => {
    const recordDateStr = (typeof r.time === "string") ? r.time.split(" ")[0] : "";
    const matchDate = !filterDate || recordDateStr === filterDate; 
    const matchesKeyword = !q || Object.values(r).some(v =>
      typeof v === "string" && v.toLowerCase().includes(q)
    );
    return matchDate && matchesKeyword;
  }).sort((a, b) => (a.time || "").localeCompare(b.time || "")).forEach(r => { 
    let dateOnly = "â€”", timeOnly = "â€”";
    if (typeof r.time === "string") {
      const parts = r.time.split(" ");
      dateOnly = parts[0];
      timeOnly = parts.slice(1).join(" "); 
    }
    const tr = tbody.insertRow();
    tr.innerHTML = `
      <td>${r.name}</td><td>${r.chart}</td><td>${r.part}</td>
      <td>${dateOnly}</td><td>${timeOnly}</td>
      <td>${r.note || ""}</td>
      <td class="noprint"><button onclick="removeRecord('${r.key}')">åˆªé™¤</button></td>
    `;
  });
}

function saveSeal() {
  const date = document.getElementById("sealDate").value;
  const am = document.getElementById("sealAM").checked; 
  const pm = document.getElementById("sealPM").checked; 
  if (!date) return alert("è«‹é¸æ“‡è¦å°å°çš„æ—¥æœŸ");
  if (mode !== "CT" && mode !== "MRI") return alert("åªæœ‰ CT å’Œ MRI æ¨¡å¼æ”¯æ´å°å°åŠŸèƒ½ã€‚");

  let sealRefPath = (mode === "CT" ? "seals_ct/" : "seals_mri/") + date;

  if (!am && !pm) { 
    db.ref(sealRefPath).remove(() => {
      alert(`æ—¥æœŸ ${date} çš„ (${mode}) å°å°å·²å–æ¶ˆ`);
      loadRecords(); 
    });
  } else { 
    db.ref(sealRefPath).set({ am, pm }, () => {
      alert(`æ—¥æœŸ ${date} çš„ (${mode}) å°å°è¨­å®šå·²å„²å­˜`);
      loadRecords(); 
    });
  }
}

function generateCombinedPrint() {
  const area = document.getElementById("printCombinedArea");
  area.innerHTML = ""; 
  const printDate = document.getElementById("dateFilter").value || document.getElementById("todayBanner").textContent; 

  let modesToPrint = [];
  let mainPrintTitle = "";

  if (mode === "MRI") { 
    mainPrintTitle = `${printDate} MRI æ ¸ç£å…±æŒ¯ æª¢æŸ¥æ’ç¨‹`;
    modesToPrint = [
      { key: "MRI", path: "mri_appointments", name: "MRI æ ¸ç£å…±æŒ¯" }
    ];
  } else { 
    mainPrintTitle = `${printDate} å„é …æª¢æŸ¥ç¸½è¡¨ (CT, BD, IVP)`;
    modesToPrint = [
      { key: "CT", path: "appointments", name: "CT é›»è…¦æ–·å±¤" },
      { key: "BD", path: "bd_appointments", name: "BD éª¨è³ªå¯†åº¦" },
      { key: "IVP", path: "ivp_appointments", name: "IVP éœè„ˆæ³¨å°„æ³Œå°¿æ”å½±" }
    ];
  }
  area.innerHTML = `<h2>${mainPrintTitle}</h2>`; 

  let results = [];
  let completedFetches = 0;

  modesToPrint.forEach(module => {
    db.ref(module.path).orderByChild("time").startAt(printDate).endAt(printDate + "\uf8ff").once("value", snap => {
      const records = [];
      snap.forEach(child => {
        const d = child.val();
        if (d.time && d.time.startsWith(printDate)) { 
          records.push(d);
        }
      });
      results.push({ modeName: module.name, data: records.sort((a,b) => (a.time || "").localeCompare(b.time || "")) });
      completedFetches++;
      if (completedFetches === modesToPrint.length) {
        renderPrintTable(results, printDate);
      }
    });
  });
}

function renderPrintTable(allModulesData, printDate) {
  const area = document.getElementById("printCombinedArea");

  allModulesData.forEach(block => {
    if (block.data.length === 0) return; 

    const h3 = document.createElement("h3");
    h3.textContent = `ğŸ“‹ ${block.modeName} æª¢æŸ¥æ’ç¨‹`;
    area.appendChild(h3);

    const table = document.createElement("table");
    table.innerHTML = "<thead><tr><th>å§“å</th><th>ç—…æ­·è™Ÿ</th><th>éƒ¨ä½</th><th>æ™‚æ®µ</th><th>å‚™è¨»</th></tr></thead>";
    const tbody = document.createElement("tbody");

    block.data.forEach(r => { 
      const tr = document.createElement("tr");
      const timeOnly = r.time ? r.time.split(" ").slice(1).join(" ") : "â€”"; 
      tr.innerHTML = [
        r.name || "â€”", r.chart || "â€”", r.part || "â€”",
        timeOnly, r.note || ""
      ].map(txt => `<td style='border:1px solid #ccc; padding:4px;'>${txt}</td>`).join("");
      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    area.appendChild(table);
    area.appendChild(document.createElement("br")); 
  });
  area.style.display = "block"; 

  const clearPrintArea = () => {
    area.innerHTML = "";
    area.style.display = "none";
    window.removeEventListener("afterprint", clearPrintArea);
  };
  window.addEventListener("afterprint", clearPrintArea);

  window.print(); 

  setTimeout(() => {
    if (area.style.display === "block") {
        clearPrintArea();
    }
  }, 3000);
}

/**
 * è™•ç†å¾ WebSocket (ICå¡è®€å¡æ©Ÿ) æ¥æ”¶åˆ°çš„è³‡æ–™
 * @param {object} cardData - åŒ…å«ç—…æ‚£è³‡æ–™çš„ç‰©ä»¶ (ä¾‹å¦‚ { name: "å§“å", chart: "ç—…æ­·è™Ÿ/å¡è™Ÿ" })
 */
function handleCardReadData(cardData) {
    console.log("å¾ WebSocket (ICå¡) æ¥æ”¶åˆ°çš„åŸå§‹è³‡æ–™: " + JSON.stringify(cardData));
    const lookupResultDiv = document.getElementById("lookupResult");

    if (cardData.name) {
        document.getElementById("name").value = cardData.name;
        document.getElementById("search").value = cardData.name; 
        
        document.getElementById("chart").value = ""; 
        if (cardData.chart) {
             console.log("ICå¡è®€å–åˆ°çš„å¡è™Ÿ/ç—…æ­·è™Ÿ (ä¸æœƒè‡ªå‹•å¡«å…¥ç—…æ­·è™Ÿæ¬„ä½): " + cardData.chart);
        }

        renderTable(); 

        const currentMonthKey = new Date().toISOString().slice(0, 7);
        const lookupModules = [
            { path: "appointments", name: "CT" }, { path: "mri_appointments", name: "MRI" },
            { path: "bd_appointments", name: "BD" }, { path: "ivp_appointments", name: "IVP" }
        ];
        let resultText = "";
        let foundOverall = false;
        let checkedModules = 0;
        lookupResultDiv.innerHTML = `æŸ¥è©¢ ${cardData.name} æœ¬æœˆé ç´„ä¸­... (ICå¡è®€å–)`;

        lookupModules.forEach(module => {
            db.ref(module.path).orderByChild("name").equalTo(cardData.name).once("value", snap => {
                snap.forEach(child => {
                    const d = child.val();
                    if (d.time && d.time.startsWith(currentMonthKey)) {
                        const timePart = d.time.split(" ")[1];
                        resultText += `ğŸ“ ${module.name}ï¼š${d.time.split(" ")[0]} ${timePart} ${d.part}<br>`;
                        foundOverall = true;
                    }
                });
                checkedModules++;
                if (checkedModules === lookupModules.length) {
                    if (!foundOverall) resultText = `âŒ æœ¬æœˆæœªæ‰¾åˆ° ${cardData.name} çš„æ’ç¨‹è³‡æ–™ (ICå¡è®€å–)`;
                    lookupResultDiv.innerHTML = resultText;
                }
            });
        });
    } else {
         lookupResultDiv.innerHTML = "ICå¡è®€å¡è³‡æ–™ä¸å®Œæ•´ (ç¼ºå°‘å§“å)ã€‚";
    }
}

/**
 * è™•ç†å¾ç—…æ­·è™Ÿæ¬„ä½è¼¸å…¥ (æ‰‹å‹•æˆ–æƒç¢¼æ©Ÿ) çš„è³‡æ–™
 */
function handleChartNumberEntry() {
    const chartNo = document.getElementById("chart").value.trim();
    const lookupResultDiv = document.getElementById("lookupResult");
    
    console.log("è™•ç†ç—…æ­·è™Ÿè¼¸å…¥/æƒç¢¼: " + chartNo);

    if (!chartNo) {
        lookupResultDiv.innerHTML = "è«‹è¼¸å…¥æˆ–æƒæç—…æ­·è™Ÿã€‚";
        document.getElementById("name").value = ""; 
        document.getElementById("search").value = ""; 
        renderTable(); 
        return;
    }
    if (!/^\d{8}$/.test(chartNo)) { 
        lookupResultDiv.innerHTML = "<span style='color:red;'>ç—…æ­·è™Ÿç¢¼å¿…é ˆæ˜¯8ä½æ•¸å­—ï¼</span>";
        document.getElementById("chart").focus();
        document.getElementById("name").value = ""; 
        return;
    }

    document.getElementById("search").value = chartNo; 
    renderTable(); 

    const filterDate = document.getElementById("dateFilter").value;
    const matchingAppointmentsToday = allData.filter(r => r.chart === chartNo && r.time && r.time.startsWith(filterDate));

    if (matchingAppointmentsToday.length === 1) {
        const patientName = matchingAppointmentsToday[0].name;
        document.getElementById("name").value = patientName;
        lookupResultDiv.innerHTML = `å·²å¸¶å…¥ç—…æ‚£ ${patientName} çš„è³‡æ–™ (ç—…æ­·è™Ÿ: ${chartNo})ã€‚`;
    } else if (matchingAppointmentsToday.length > 1) {
        document.getElementById("name").value = ""; 
        lookupResultDiv.innerHTML = `<span style='color:orange;'>æ³¨æ„ï¼šç—…æ­·è™Ÿ ${chartNo} åœ¨ ${filterDate} (${mode}æ¨¡çµ„) æœ‰å¤šç­†é ç´„ï¼Œè«‹æ‰‹å‹•ç¢ºèªå§“åã€‚</span>`;
    } else {
        document.getElementById("name").value = ""; 
        lookupResultDiv.innerHTML = `ç—…æ­·è™Ÿ ${chartNo} åœ¨ ${filterDate} (${mode}æ¨¡çµ„) ç„¡é ç´„ã€‚`;
        const anyMatchingAppointment = allData.find(r => r.chart === chartNo);
        if (anyMatchingAppointment) {
            document.getElementById("name").value = anyMatchingAppointment.name;
            lookupResultDiv.innerHTML += `<br>(ç³»çµ±å·²æ ¹æ“šæ­¤ç—…æ­·è™Ÿå¾æ‰€æœ‰ç´€éŒ„ä¸­å¸¶å…¥å§“å: ${anyMatchingAppointment.name})`;
        } else {
            lookupResultDiv.innerHTML += `<br>(åœ¨æ‰€æœ‰ç´€éŒ„ä¸­ä¹Ÿæœªæ‰¾åˆ°æ­¤ç—…æ­·è™Ÿå°æ‡‰çš„å§“å)`;
        }
    }
}

// *** æ–°å¢ï¼šICå¡è®€å¡æ©Ÿçš„ WebSocket è¨­å®š ***
function setupWebSocket() {
  try {
    const socket = new WebSocket("ws://localhost:8765"); 
    socket.onopen = function() { 
        console.log("WebSocket é€£ç·šæˆåŠŸ (ICå¡è®€å¡æ©Ÿ)"); 
        document.getElementById("lookupResult").innerHTML = "ICå¡è®€å¡æ©Ÿå·²é€£ç·šï¼Œè«‹åˆ·å¡ã€‚<strong>è‹¥ä¸ä½¿ç”¨ICå¡ï¼Œå¯ç›´æ¥æƒææˆ–è¼¸å…¥ç—…æ­·è™Ÿã€‚</strong>"; 
    };
    socket.onmessage = function (event) { 
      try {
        const data = JSON.parse(event.data); 
        handleCardReadData(data); 
      } catch (e) {
        console.error("è™•ç† WebSocket è¨Šæ¯éŒ¯èª¤ï¼š", e);
        document.getElementById("lookupResult").innerHTML = "<span style='color:red;'>è™•ç†ICå¡è®€å¡è³‡æ–™éŒ¯èª¤</span>";
      }
    };
    socket.onerror = function(error) {
        console.error("WebSocket éŒ¯èª¤ï¼š", error);
        document.getElementById("lookupResult").innerHTML = "<span style='color:red;'>ICå¡è®€å¡æ©Ÿ WebSocket é€£ç·šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥è®€å¡æœå‹™æ˜¯å¦å·²å•Ÿå‹•ã€‚</span> <strong>ä»å¯ä½¿ç”¨æƒç¢¼æ©Ÿæˆ–æ‰‹å‹•è¼¸å…¥ç—…æ­·è™Ÿã€‚</strong>";
    };
    socket.onclose = function() {
        console.log("WebSocket é€£ç·šé—œé–‰ (ICå¡è®€å¡æ©Ÿ)");
        document.getElementById("lookupResult").innerHTML = "<span style='color:orange;'>ICå¡è®€å¡æ©Ÿ WebSocket é€£ç·šå·²é—œé–‰ã€‚</span> <strong>ä»å¯ä½¿ç”¨æƒç¢¼æ©Ÿæˆ–æ‰‹å‹•è¼¸å…¥ç—…æ­·è™Ÿã€‚</strong>";
    };
  } catch (e) {
    console.error("å»ºç«‹ WebSocket é€£ç·šå¤±æ•—ï¼š", e);
    document.getElementById("lookupResult").innerHTML = "<span style='color:red;'>ç„¡æ³•å»ºç«‹ICå¡è®€å¡æ©Ÿ WebSocket é€£ç·šã€‚</span> <strong>ä»å¯ä½¿ç”¨æƒç¢¼æ©Ÿæˆ–æ‰‹å‹•è¼¸å…¥ç—…æ­·è™Ÿã€‚</strong>";
  }
}


// å…¨åŸŸæƒç¢¼ç›£è½å™¨ç›¸é—œè®Šæ•¸èˆ‡å‡½æ•¸
let scannedChartNumberBuffer = "";
let interDigitTimeout = null; 
const INTER_DIGIT_TIMEOUT_DURATION = 400; 
let processScanTimeout = null; 
const PROCESS_SCAN_TIMEOUT_DURATION = 75; 

function clearScanBufferAndTimers() {
    scannedChartNumberBuffer = "";
    clearTimeout(interDigitTimeout);
    clearTimeout(processScanTimeout);
}

function setupGlobalScannerListener() {
    console.log("è¨­å®šå…¨åŸŸæƒç¢¼ç›£è½å™¨ (è‡ªå‹•è™•ç†8ä½æ•¸)...");
    document.addEventListener('keydown', function(event) {
        if (document.getElementById('protected').style.display !== 'block') {
            clearScanBufferAndTimers();
            return;
        }

        const activeElement = document.activeElement;
        const excludedElementIds = ['name', 'part', 'note', 'search', 'passwordInput', 'date', 'dateFilter', 'sealDate', 'time'];
        
        if (activeElement && 
            (excludedElementIds.includes(activeElement.id) ||
             activeElement.tagName === 'TEXTAREA' ||
             activeElement.tagName === 'SELECT' ||
             (activeElement.tagName === 'INPUT' && (activeElement.type === 'password' || activeElement.type === 'search' || activeElement.type === 'date'))
            ) && activeElement.id !== 'chart' 
        ) {
            if (event.key >= '0' && event.key <= '9') {
                clearScanBufferAndTimers(); 
                return; 
            }
        }

        if (event.key >= '0' && event.key <= '9') { 
            scannedChartNumberBuffer += event.key;
            clearTimeout(interDigitTimeout); 
            interDigitTimeout = setTimeout(() => {
                scannedChartNumberBuffer = ""; 
            }, INTER_DIGIT_TIMEOUT_DURATION);

            if (scannedChartNumberBuffer.length === 8) {
                clearTimeout(processScanTimeout); 
                processScanTimeout = setTimeout(() => { 
                    if (scannedChartNumberBuffer.length === 8) { 
                        console.log("å…¨åŸŸæƒç¢¼åµæ¸¬åˆ°8ä½æ•¸ç—…æ­·è™Ÿ (è¶…æ™‚è‡ªå‹•è™•ç†): " + scannedChartNumberBuffer);
                        document.getElementById('chart').value = scannedChartNumberBuffer; 
                        handleChartNumberEntry(); 
                        clearScanBufferAndTimers(); 
                    }
                }, PROCESS_SCAN_TIMEOUT_DURATION);
            } else if (scannedChartNumberBuffer.length > 8) { 
                clearScanBufferAndTimers();
            }
        } else if (event.key === 'Enter') { 
            clearTimeout(interDigitTimeout);    
            clearTimeout(processScanTimeout); 
            if (document.activeElement.id !== 'chart') {
                if (scannedChartNumberBuffer.length === 8 && /^\d{8}$/.test(scannedChartNumberBuffer)) { 
                    event.preventDefault(); 
                    console.log("å…¨åŸŸæƒç¢¼åµæ¸¬åˆ°ç—…æ­·è™Ÿ (Enteréµï¼Œç„¦é»échart): " + scannedChartNumberBuffer);
                    document.getElementById('chart').value = scannedChartNumberBuffer; 
                    handleChartNumberEntry(); 
                }
            }
            clearScanBufferAndTimers(); 
        } else {
            if (!event.ctrlKey && !event.altKey && !event.metaKey && event.key.length === 1) {
                clearScanBufferAndTimers();
            }
        }
    });
}


function removeRecord(key) {
  if (confirm("ç¢ºå®šåˆªé™¤æ­¤ç­†é ç´„ç´€éŒ„ï¼Ÿ")) {
    db.ref(getCurrentAppointmentPath() + "/" + key).remove(err => {
        if (!err) {
            alert("ç´€éŒ„å·²åˆªé™¤");
            loadRecords(); 
        } else {
            alert("åˆªé™¤å¤±æ•—ï¼š" + err.message);
        }
    });
  }
}
</script>
</body>
</html>
