<!DOCTYPE html>

<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>CT æª¢æŸ¥æ’ç¨‹è¡¨å–®</title>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js">
// WebSocket é€£ç·šï¼ˆæ¥æ”¶å¯¦éš›æˆ–æ¨¡æ“¬çš„å§“åï¼‰
try {
  const socket = new WebSocket("ws://localhost:8765");
  socket.addEventListener("message", function (event) {
    const data = JSON.parse(event.data);
    const name = data.name;
    document.getElementById("name").value = name;

    const monthKey = new Date().toISOString().slice(0, 7);
    const modules = ["appointments", "bd_appointments", "ivp_appointments"];
    let resultText = "";
    let found = false;
    let checked = 0;

    modules.forEach(path => {
      firebase.database().ref(path).once("value", snap => {
        snap.forEach(child => {
          const d = child.val();
          if (d.name === name && d.time && d.time.startsWith(monthKey)) {
            const timePart = d.time.split(" ")[1];
            resultText += `ğŸ“ ${path.replace("_appointments", "").toUpperCase()}ï¼š${timePart} ${d.part}<br>`;
            found = true;
          }
        });
        checked++;
        if (checked === modules.length) {
          if (!found) resultText = "âŒ æœ¬æœˆæœªæ‰¾åˆ° " + name + " çš„æ’ç¨‹è³‡æ–™";
          document.getElementById("lookupResult").innerHTML = resultText;
        }
      });
    });
  });
} catch (e) {
  console.error("WebSocket éŒ¯èª¤ï¼š", e);
}
</script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js">
// WebSocket é€£ç·šï¼ˆæ¥æ”¶å¯¦éš›æˆ–æ¨¡æ“¬çš„å§“åï¼‰
try {
  const socket = new WebSocket("ws://localhost:8765");
  socket.addEventListener("message", function (event) {
    const data = JSON.parse(event.data);
    const name = data.name;
    document.getElementById("name").value = name;

    const monthKey = new Date().toISOString().slice(0, 7);
    const modules = ["appointments", "bd_appointments", "ivp_appointments"];
    let resultText = "";
    let found = false;
    let checked = 0;

    modules.forEach(path => {
      firebase.database().ref(path).once("value", snap => {
        snap.forEach(child => {
          const d = child.val();
          if (d.name === name && d.time && d.time.startsWith(monthKey)) {
            const timePart = d.time.split(" ")[1];
            resultText += `ğŸ“ ${path.replace("_appointments", "").toUpperCase()}ï¼š${timePart} ${d.part}<br>`;
            found = true;
          }
        });
        checked++;
        if (checked === modules.length) {
          if (!found) resultText = "âŒ æœ¬æœˆæœªæ‰¾åˆ° " + name + " çš„æ’ç¨‹è³‡æ–™";
          document.getElementById("lookupResult").innerHTML = resultText;
        }
      });
    });
  });
} catch (e) {
  console.error("WebSocket éŒ¯èª¤ï¼š", e);
}
</script>
<style>
    body { font-family: sans-serif; max-width: 1200px; margin: auto; padding: 20px; display: flex; flex-direction: column; }
    input, select, button, textarea {
      display: block; width: 100%; margin: 10px 0; padding: 8px; font-size: 16px;
    }
    button { background-color: #4CAF50; color: white; border: none; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    th { background: #f0f0f0; }
    @media print { .noprint { display: none !important; } }
    #sealPanel { float: right; border: 1px solid #ccc; padding: 10px; margin-left: 20px; width: 280px; background: #f9f9f9; }
    #formSection { flex: 1; max-width: 800px; }
  
body {
  font-family: "Segoe UI", "Noto Sans TC", sans-serif;
  background: url('8c829460-d144-11e9-8e6f-74942275b45f.jpg') no-repeat center center fixed;
  background-size: cover;
  backdrop-filter: blur(4px);
  color: #333;
}
input, select, button, textarea {
  border-radius: 8px;
  border: 1px solid #ccc;
}
button {
  background-color: #ffd1dc;
  color: black;
  transition: 0.3s ease;
}
button:hover {
  background-color: #f48fb1;
}
table {
  background: rgba(255,255,255,0.95);
}
th {
  background: #ffe4ec;
  color: #880e4f;
}
#sealPanel {
  background: rgba(255,255,255,0.85);
}
@media print {
  body * {
    visibility: hidden;
  }
  #recordTable, #recordTable * {
    visibility: visible;
  }
  #recordTable {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
  }
}

@media print {
  body * {
    visibility: hidden !important;
  }
  #printCombinedArea, #printCombinedArea * {
    visibility: visible !important;
  }
  #printCombinedArea {
    position: absolute;
    top: 0;
    left: 0;
    width: 60%; margin: auto;
  }
}


@media print {
  body * {
    visibility: hidden !important;
  }
  #printCombinedArea, #printCombinedArea * {
    visibility: visible !important;
    font-size: 12px !important;
  }
  #printCombinedArea {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
  }
  #printCombinedArea table {
    font-size: 12px;
    width: 60%;
    margin: auto;
  }
  #printCombinedArea th, #printCombinedArea td {
    padding: 2px 4px !important;
  }
}


table th:nth-child(1),
table td:nth-child(1) {
  width: 80px;
}

</style>
</head>
<body>
<div id="loginForm">
<h3>ğŸ”’ è«‹è¼¸å…¥å¯†ç¢¼é€²å…¥ç³»çµ±</h3>
<input id="passwordInput" placeholder="è¼¸å…¥å¯†ç¢¼" type="password"/>
<button onclick="checkPassword()">ç™»å…¥</button>
</div>
<div id="protected" style="display:none;">
<div style="display: flex; justify-content: space-between; align-items: flex-start;">
<div id="formSection">
<div class="noprint" style="margin-bottom:10px;"><img src="logo.png" style="height:60px;"></div>
<h2>æª¢æŸ¥æ’ç¨‹è¡¨å–®ï¼ˆ<span id="modeTitle">CT</span> æ¨¡çµ„ï¼‰</h2>
    <div style="margin-bottom:10px;">
      <button onclick="switchMode('CT')">åˆ‡æ›ç‚º CT</button>
      <button onclick="switchMode('BD')">åˆ‡æ›ç‚º BD</button>
      <button onclick="switchMode('IVP')">åˆ‡æ›ç‚º IVP</button>
    </div>
<div>ğŸ“… ä»Šæ—¥æ—¥æœŸï¼š<span id="todayBanner"></span></div>
<button onclick="simulateCardRead()" style="margin-bottom:10px;">ğŸ”˜ æ¨¡æ“¬è®€å¡ï¼ˆç‹å°æ˜ï¼‰</button>
<div id="lookupResult" style="font-weight:bold; margin-top:10px;"></div>
<label>ç—…äººå§“åï¼š<input id="name"/></label>
<label>ç—…æ­·è™Ÿï¼š<input id="chart"/></label>
<label>æª¢æŸ¥éƒ¨ä½ï¼š
      <select id="part"></select>
    </label>
<label>æª¢æŸ¥æ—¥æœŸï¼š<input id="date" onchange="disableUsedTimeSlots()" type="date"/></label>
<label>æª¢æŸ¥æ™‚æ®µï¼š
        <select id="time">
<option>è«‹é¸æ“‡</option>
<option>08:00</option><option>08:20</option><option>08:40</option>
<option>09:00</option><option>09:20</option><option>09:40</option>
<option>10:00</option><option>10:20</option><option>10:40</option>
<option>11:00</option><option>11:20 tumor</option><option>11:40 ç—…æˆ¿</option>
<option>13:20</option><option>13:40</option><option>14:00</option>
<option>14:20</option><option>14:40</option><option>15:00</option>
<option>15:20</option><option>15:40</option><option>16:00 ç—…æˆ¿</option>
</select>
</label>
<label>å‚™è¨»ï¼š<textarea id="note"></textarea></label>
<button onclick="submitForm()">é€å‡ºæ’ç¨‹</button>
<h3>ğŸ“‹ å·²é ç´„æ¸…å–®</h3>
<label>ç¯©é¸æ—¥æœŸï¼š<input id="dateFilter" onchange="renderTable()" type="date"/></label>
<input id="search" oninput="renderTable()" placeholder="æœå°‹å§“åã€ç—…æ­·è™Ÿã€éƒ¨ä½æˆ–æ™‚æ®µ..."/>
<button onclick="loadRecords()">è¼‰å…¥é ç´„ç´€éŒ„</button>
<button onclick="generateCombinedPrint()">ç”¢å‡ºåˆ—å°ç¸½è¡¨</button>
<table id="recordTable">
<thead><tr><th>å§“å</th><th>ç—…æ­·è™Ÿ</th><th>éƒ¨ä½</th><th>æ—¥æœŸ</th><th>æ™‚æ®µ</th><th>å‚™è¨»</th><th class="noprint">æ“ä½œ</th></tr></thead>
<tbody></tbody>
</table>
<div id="printCombinedArea" style="display:none; margin-top:30px;"></div>
</div>
<div id="sealPanel" style="display:none;">
<h4>ğŸ“Œ å°å°æ’æª¢æ™‚æ®µç®¡ç†</h4>
<label>é¸æ“‡æ—¥æœŸï¼š<input id="sealDate" type="date"/></label>
<label><input id="sealAM" type="checkbox"/> å°å°ä¸Šåˆ</label>
<label><input id="sealPM" type="checkbox"/> å°å°ä¸‹åˆ</label>
<button onclick="saveSeal()">å„²å­˜å°å°è¨­å®š</button>
<div style="margin-top: 20px;">
<h4>ğŸ“‹ å°å°æ’æª¢æ™‚æ®µç¸½è¦½</h4>
<ul id="sealSummaryList" style="padding-left: 20px;"></ul>
</div>
</div>
</div>
</div>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyBLgUdGaDarOAQF_5YGo4df6KyU8DsclA0",
  authDomain: "ct-reserve.firebaseapp.com",
  databaseURL: "https://ct-reserve-default-rtdb.firebaseio.com",
  projectId: "ct-reserve",
  storageBucket: "ct-reserve.appspot.com",
  messagingSenderId: "263734590112",
  appId: "1:263734590112:web:34fec465ce56d91f68a7c5"
};
firebase.initializeApp(firebaseConfig);
let mode = 'CT';
const ctParts = [
  "è«‹é¸æ“‡",
  "å¿ƒè‡Ÿéˆ£åŒ–é›»è…¦æ–·å±¤æ”å½± Calcification(ä¸æ‰“è—¥)",
  "å¿ƒè‡Ÿé›»è…¦æ–·å±¤è¡€ç®¡æ”å½±å¥—çµ„ HEART CTA+Calcification(æ‰“è—¥)",
  "é ­éƒ¨ brain(æ‰“è—¥)",
  "é ­éƒ¨ brain(ä¸æ‰“è—¥)",
  "é ¸éƒ¨ neck(æ‰“è—¥)",
  "é ¸éƒ¨ neck(ä¸æ‰“è—¥)",
  "é ¸æ¤ c-spine(æ‰“è—¥)",
  "é ¸æ¤ c-spine(ä¸æ‰“è—¥)",
  "èƒ¸éƒ¨ chest(æ‰“è—¥)",
  "èƒ¸éƒ¨ chest(ä¸æ‰“è—¥)",
  "ä½è¼»å°„åŠ‘é‡è‚ºéƒ¨ç¯©æª¢ Low dose lung screen(ä¸æ‰“è—¥)",
  "é«˜è§£æè‚ºéƒ¨ HRCT(ä¸æ‰“è—¥)",
  "è…¹éƒ¨ Abdomen(æ‰“è—¥)",
  "è…¹éƒ¨ Abdomen(ä¸æ‰“è—¥)",
  "è…°æ¤ L-spine(æ‰“è—¥)",
  "è…°æ¤ L-spine(ä¸æ‰“è—¥)",
  "èƒ¸æ¤ T-spine(æ‰“è—¥)",
  "èƒ¸æ¤ T-spine(ä¸æ‰“è—¥)",
  "4è‚¢ Limbs(æ‰“è—¥)",
  "4è‚¢ Limbs(ä¸æ‰“è—¥)"
];
const bdParts = [
  "è«‹é¸æ“‡",
  "è…°æ¤éª¨è³ªå¯†åº¦(L-SPINE)",
  "å…©å´é«–é—œç¯€éª¨è³ªå¯†åº¦(Bilateral HIP)",
  "è…°æ¤éª¨è³ªå¯†åº¦(L-SPINE) + å…©å´é«–é—œç¯€éª¨è³ªå¯†åº¦(Bilateral HIP)",
  "è…°æ¤å´ä½éª¨è³ªå¯†åº¦(L-SPINE Lateral)"
];

const ivpParts = [
  "è«‹é¸æ“‡",
  "éœè„ˆæ³¨å°„æ³Œå°¿ç³»çµ±æ”å½±æª¢æŸ¥(IVP)"
];

function switchMode(newMode) {
  mode = newMode;
  document.getElementById("modeTitle").textContent = mode;
  document.getElementById("sealPanel").style.display = (mode === "CT") ? "block" : "none";
  const partSelect = document.getElementById("part");
  let parts = ctParts;
  if (mode === "BD") parts = bdParts;
  else if (mode === "IVP") parts = ivpParts;
  partSelect.innerHTML = parts.map(p => `<option>${p}</option>`).join('');
  loadRecords(); // refresh list
}

const db = firebase.database();
let allData = [];
let seals = {};
function cleanupOldRecords() {
  const today = new Date();
  const cutoff = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());

  // æ¸…é™¤ appointments è¶…éä¸€å€‹æœˆå‰çš„è³‡æ–™
  let refPath = "appointments"; if (mode === "BD") refPath = "bd_appointments"; else if (mode === "IVP") refPath = "ivp_appointments";
  db.ref(refPath).once("value", snap => {
    snap.forEach(child => {
      const r = child.val();
      if (r.time && typeof r.time === "string") {
        const datePart = r.time.split(" ")[0];
        const recordDate = new Date(datePart);
        if (recordDate < cutoff) {
          db.ref("appointments/" + child.key).remove();
        }
      }
    });
  });

  // æ¸…é™¤ seals è¶…éä¸€å€‹æœˆå‰çš„è³‡æ–™
  db.ref("seals").once("value", snap => {
    snap.forEach(child => {
      const dateStr = child.key;
      const sealDate = new Date(dateStr);
      if (sealDate < cutoff) {
        db.ref("seals/" + dateStr).remove();
      }
    });
  });
}

function disableUsedTimeSlots() {
  const selectedDate = document.getElementById("date").value;
  const usedTimes = allData
    .filter(r => typeof r.time === "string" && r.time.startsWith(selectedDate))
    .map(r => r.time.split(" ")[1]);

  const timeSelect = document.getElementById("time");
  Array.from(timeSelect.options).forEach(opt => {
    if (usedTimes.includes(opt.value)) {
      opt.disabled = true;
      opt.title = 'æ­¤æ™‚æ®µå·²è¢«é ç´„';
    } else {
      opt.disabled = false;
      opt.title = '';
    }
  });
}

function updateSealSummary() {
  const list = document.getElementById("sealSummaryList");
  if (!list) return;
  list.innerHTML = "";
  Object.keys(seals).sort().forEach(date => {
    const s = seals[date];
    const label = `${date}ï¼š${s.am ? "ä¸Šåˆå°å°" : ""}${s.am && s.pm ? "ã€" : ""}${s.pm ? "ä¸‹åˆå°å°" : ""}`;
    if (s.am || s.pm) {
      const li = document.createElement("li");
      li.textContent = label;
      list.appendChild(li);
    }
  });
}


function checkPassword() {
  const input = document.getElementById("passwordInput").value;
  if (input === "km1234") {
    document.getElementById("protected").style.display = "block";
    document.getElementById("loginForm").style.display = "none";
  } else alert("å¯†ç¢¼éŒ¯èª¤");
}

document.addEventListener("DOMContentLoaded", () => {
  const input = document.getElementById("passwordInput");
  if (input) {
    input.addEventListener("keypress", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        checkPassword();
      }
    });
  }
});

function submitForm() {
  const name = document.getElementById("name").value.trim();
  const chart = document.getElementById("chart").value.trim();
  const part = document.getElementById("part").value;
  const date = document.getElementById("date").value;
  const timeSlot = document.getElementById("time").value;
  const note = document.getElementById("note").value.trim();
  if (!name || !chart || part === "è«‹é¸æ“‡" || timeSlot === "è«‹é¸æ“‡" || !date)
    return alert("è«‹å®Œæ•´å¡«å¯«");

  const [hour] = timeSlot.split(":");
  const isAM = parseInt(hour) < 12;
  if (mode === "CT" && ((isAM && seals[date]?.am) || (!isAM && seals[date]?.pm))) {
    return alert("è©²æ—¥æœŸæ™‚æ®µå·²å°å°ï¼Œç„¡æ³•æ’æª¢ï¼");
  }

  const time = `${date} ${timeSlot}`;
  const record = { name, chart, part, time, note, createdAt: Date.now() };
  let refPath = "appointments"; if (mode === "BD") refPath = "bd_appointments"; else if (mode === "IVP") refPath = "ivp_appointments";
  db.ref(refPath).push(record, err => {
    if (!err) {
      alert("å·²é€å‡º");
      document.querySelectorAll("input, textarea").forEach(el => el.value = "");
      document.getElementById("part").selectedIndex = 0;
      document.getElementById("time").selectedIndex = 0;
      const today = new Date(Date.now() + 8 * 3600 * 1000).toISOString().split("T")[0];
      document.getElementById("date").value = today;
      document.getElementById("dateFilter").value = today;
      loadRecords();
  cleanupOldRecords();
    }
  });
}

function loadRecords() {
  let refPath = "appointments"; if (mode === "BD") refPath = "bd_appointments"; else if (mode === "IVP") refPath = "ivp_appointments";
  db.ref(refPath).once("value", snap => {
    allData = [];
    snap.forEach(child => {
      const d = child.val();
      d.key = child.key;
      allData.push(d);
    });
    renderTable();
    disableUsedTimeSlots();
  });
  db.ref("seals").once("value", snap => {
    seals = snap.val() || {};
    updateSealSummary();
  });
}

function renderTable() {
  const q = document.getElementById("search").value.toLowerCase();
  const filterDate = document.getElementById("dateFilter").value;
  const tbody = document.querySelector("tbody");
  tbody.innerHTML = "";

  allData.filter(r => {
    const matchDate = !filterDate || (typeof r.time === "string" && r.time.startsWith(filterDate));
    const matchesKeyword = !q || Object.values(r).some(v =>
      typeof v === "string" && v.toLowerCase().includes(q)
    );
    return matchDate && matchesKeyword;
  }).sort((a, b) => a.time.localeCompare(b.time)).forEach(r => {
    let dateOnly = "â€”", showTime = "â€”";
    if (typeof r.time === "string") {
      const parts = r.time.split(" ");
      dateOnly = parts[0];
      showTime = r.time;
    }
    const tr = tbody.insertRow();
    tr.innerHTML = `
      <td>${r.name}</td><td>${r.chart}</td><td>${r.part}</td><td>${dateOnly}</td><td>${showTime}</td><td>${r.note || ""}</td>
      <td class="noprint"><button onclick="removeRecord('${r.key}')">åˆªé™¤</button></td>
    `;
  });
}

function saveSeal() {
  const date = document.getElementById("sealDate").value;
  const am = document.getElementById("sealAM").checked;
  const pm = document.getElementById("sealPM").checked;
  if (!date) return alert("è«‹é¸æ“‡æ—¥æœŸ");
  if (!am && !pm) {
    db.ref("seals/" + date).remove(() => {
      alert("å·²å–æ¶ˆå°å°");
      loadRecords();
  cleanupOldRecords();
    });
  } else {
    db.ref("seals/" + date).set({ am, pm }, () => {
      alert("å°å°è¨­å®šå·²å„²å­˜");
      loadRecords();
  cleanupOldRecords();
    });
  }
}


function printAll() {
  const modes = ["CT", "BD", "IVP"];
  let i = 0;
  function nextPrint() {
    if (i >= modes.length) return;
    switchMode(modes[i]);
    setTimeout(() => {
      window.print();
      i++;
      setTimeout(nextPrint, 1000); // é¿å…åˆ—å°é‡ç–Š
    }, 1000);
  }
  nextPrint();
}



function generateCombinedPrint() {
  const area = document.getElementById("printCombinedArea");
  area.innerHTML = "";
  const monthKey = "2025-05";

  const modes = ["CT", "BD", "IVP"];
  let results = [];
  let completed = 0;

  modes.forEach(modeKey => {
    let refPath = modeKey === "CT" ? "appointments" : (modeKey === "BD" ? "bd_appointments" : "ivp_appointments");
    firebase.database().ref(refPath).once("value", snap => {
      const records = [];
      snap.forEach(child => {
        const d = child.val();
        if (d.time && d.time.startsWith(today)) {
          records.push(d);
        }
      });
      results.push({ mode: modeKey, data: records });
      completed++;
      if (completed === 3) renderPrintTable(results);
    });
  });
}

function renderPrintTable(allModules) {
  const area = document.getElementById("printCombinedArea");
  area.innerHTML = "";
  area.style.display = "block";

  allModules.forEach(block => {
    const h3 = document.createElement("h3");
    h3.textContent = "ğŸ“‹ " + block.mode + " æª¢æŸ¥æ’ç¨‹";
    area.appendChild(h3);

    const table = document.createElement("table");
    table.style.width = "100%";
    table.style.borderCollapse = "collapse";
    table.innerHTML = "<thead><tr><th>å§“å</th><th>ç—…æ­·è™Ÿ</th><th>éƒ¨ä½</th><th>æ™‚æ®µ</th><th>å‚™è¨»</th></tr></thead>";
    const tbody = document.createElement("tbody");

    block.data.sort((a, b) => a.time.localeCompare(b.time)).forEach(r => {
      const tr = document.createElement("tr");
      const tds = [
        r.name || "â€”", r.chart || "â€”", r.part || "â€”",
        r.time ? r.time.split(" ")[1] : "â€”", r.note || ""
      ].map(txt => `<td style='border:1px solid #ccc; padding:4px;'>${txt}</td>`).join("");
      tr.innerHTML = tds;
      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    area.appendChild(table);
    area.appendChild(document.createElement("br"));
  });

  // é¿å…åŸæœ¬é é¢åˆ—å°ï¼Œåƒ…åˆ—å°ç¸½è¡¨
  window.print();
}



function simulateCardRead() {
  const name = "ç‹å°æ˜";
  document.getElementById("name").value = name;

  const monthKey = "2025-05";
  const modules = ["appointments", "bd_appointments", "ivp_appointments"];
  let resultText = "";
  let found = false;
  let checked = 0;

  modules.forEach(path => {
    firebase.database().ref(path).once("value", snap => {
      snap.forEach(child => {
        const d = child.val();
        if (d.name === name && d.time && d.time.startsWith(monthKey)) {
          const timePart = d.time.split(" ")[1];
          resultText += `ğŸ“ ${path.replace("_appointments", "").toUpperCase()}ï¼š${timePart} ${d.part}<br>`;
          found = true;
        }
      });
      checked++;
      if (checked === modules.length) {
        if (!found) resultText = "âŒ æœ¬æœˆæœªæ‰¾åˆ°ç‹å°æ˜çš„æ’ç¨‹è³‡æ–™";
        document.getElementById("lookupResult").innerHTML = resultText;
      }
    });
  });
}



function generateCombinedPrint() {
  const area = document.getElementById("printCombinedArea");
  area.innerHTML = "";
  const today = document.getElementById("date").value;
  const modes = ["CT", "BD", "IVP"];
  let results = [];
  let completed = 0;

  modes.forEach(modeKey => {
    let refPath = modeKey === "CT" ? "appointments" :
                  modeKey === "BD" ? "bd_appointments" : "ivp_appointments";
    firebase.database().ref(refPath).once("value", snap => {
      const records = [];
      snap.forEach(child => {
        const d = child.val();
        if (d.time && d.time.startsWith(today)) {
          records.push(d);
        }
      });
      results.push({ mode: modeKey, data: records });
      completed++;
      if (completed === 3) renderPrintTable(results);
    });
  });
}

function renderPrintTable(allModules) {
  const area = document.getElementById("printCombinedArea");
  area.innerHTML = "";
  area.style.display = "block";

  allModules.forEach(block => {
    const h3 = document.createElement("h3");
    h3.textContent = "ğŸ“‹ " + block.mode + " æª¢æŸ¥æ’ç¨‹";
    area.appendChild(h3);

    const table = document.createElement("table");
    table.style.width = "60%";
    table.style.margin = "auto";
    table.style.borderCollapse = "collapse";
    table.innerHTML = "<thead><tr><th>å§“å</th><th>ç—…æ­·è™Ÿ</th><th>éƒ¨ä½</th><th>æ™‚æ®µ</th><th>å‚™è¨»</th></tr></thead>";
    const tbody = document.createElement("tbody");

    block.data.sort((a, b) => a.time.localeCompare(b.time)).forEach(r => {
      const tr = document.createElement("tr");
      const tds = [
        r.name || "â€”", r.chart || "â€”", r.part || "â€”",
        r.time ? r.time.split(" ")[1] : "â€”", r.note || ""
      ].map(txt => `<td style='border:1px solid #ccc; padding:4px;'>${txt}</td>`).join("");
      tr.innerHTML = tds;
      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    area.appendChild(table);
    area.appendChild(document.createElement("br"));
  });

  window.print();
}


window.onload = () => {
  switchMode('CT');
  const now = new Date(Date.now() + 8 * 60 * 60 * 1000);
  const today = now.toISOString().split("T")[0];
  document.getElementById("todayBanner").textContent = today;
  document.getElementById("date").value = today;
  document.getElementById("dateFilter").value = today;
  document.getElementById("sealDate").value = today;
  loadRecords();
  cleanupOldRecords();
};

// WebSocket é€£ç·šï¼ˆæ¥æ”¶å¯¦éš›æˆ–æ¨¡æ“¬çš„å§“åï¼‰
try {
  const socket = new WebSocket("ws://localhost:8765");
  socket.addEventListener("message", function (event) {
    const data = JSON.parse(event.data);
    const name = data.name;
    document.getElementById("name").value = name;

    const monthKey = new Date().toISOString().slice(0, 7);
    const modules = ["appointments", "bd_appointments", "ivp_appointments"];
    let resultText = "";
    let found = false;
    let checked = 0;

    modules.forEach(path => {
      firebase.database().ref(path).once("value", snap => {
        snap.forEach(child => {
          const d = child.val();
          if (d.name === name && d.time && d.time.startsWith(monthKey)) {
            const timePart = d.time.split(" ")[1];
            resultText += `ğŸ“ ${path.replace("_appointments", "").toUpperCase()}ï¼š${timePart} ${d.part}<br>`;
            found = true;
          }
        });
        checked++;
        if (checked === modules.length) {
          if (!found) resultText = "âŒ æœ¬æœˆæœªæ‰¾åˆ° " + name + " çš„æ’ç¨‹è³‡æ–™";
          document.getElementById("lookupResult").innerHTML = resultText;
        }
      });
    });
  });
} catch (e) {
  console.error("WebSocket éŒ¯èª¤ï¼š", e);
}
</script>
</body>
</html>

<script>
function removeRecord(key) {
  if (confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) {
    let refPath = "appointments"; if (mode === "BD") refPath = "bd_appointments"; else if (mode === "IVP") refPath = "ivp_appointments";
    db.ref(refPath + "/" + key).remove(() => loadRecords());
  }
}

// WebSocket é€£ç·šï¼ˆæ¥æ”¶å¯¦éš›æˆ–æ¨¡æ“¬çš„å§“åï¼‰
try {
  const socket = new WebSocket("ws://localhost:8765");
  socket.addEventListener("message", function (event) {
    const data = JSON.parse(event.data);
    const name = data.name;
    document.getElementById("name").value = name;

    const monthKey = new Date().toISOString().slice(0, 7);
    const modules = ["appointments", "bd_appointments", "ivp_appointments"];
    let resultText = "";
    let found = false;
    let checked = 0;

    modules.forEach(path => {
      firebase.database().ref(path).once("value", snap => {
        snap.forEach(child => {
          const d = child.val();
          if (d.name === name && d.time && d.time.startsWith(monthKey)) {
            const timePart = d.time.split(" ")[1];
            resultText += `ğŸ“ ${path.replace("_appointments", "").toUpperCase()}ï¼š${timePart} ${d.part}<br>`;
            found = true;
          }
        });
        checked++;
        if (checked === modules.length) {
          if (!found) resultText = "âŒ æœ¬æœˆæœªæ‰¾åˆ° " + name + " çš„æ’ç¨‹è³‡æ–™";
          document.getElementById("lookupResult").innerHTML = resultText;
        }
      });
    });
  });
} catch (e) {
  console.error("WebSocket éŒ¯èª¤ï¼š", e);
}
</script>
</body>
</html>
