<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CT 檢查排程表單</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBLgUdGaDarOAQF_5YGo4df6KyU8DsclA0",
      authDomain: "ct-reserve.firebaseapp.com",
      projectId: "ct-reserve",
      storageBucket: "ct-reserve.firebasestorage.app",
      messagingSenderId: "263734590112",
      appId: "1:263734590112:web:34fec465ce56d91f68a7c5"
    };

    const encodeKey = (text) => text.replace(/[^a-zA-Z0-9]/g, "_");
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    document.addEventListener("DOMContentLoaded", () => {
      const timeOptions = [
        "08:00", "08:20", "08:40", "09:00", "09:20", "09:40",
        "10:00", "10:20", "10:40", "11:00",
        "11:20 - tumor", "11:40 - 病房",
        "13:20", "13:40", "14:00", "14:20", "14:40", "15:00", "15:20", "15:40",
        "16:00 - 病房"
      ];

      const timeSelect = document.getElementById("time");
      const appointmentsRef = db.ref("appointments");

      appointmentsRef.once("value", (snapshot) => {
        const taken = snapshot.exists() ? Object.keys(snapshot.val()) : [];
        timeOptions.forEach(t => {
          if (!taken.includes(encodeKey(t))) {
            const opt = document.createElement("option");
            opt.value = t;
            opt.textContent = t;
            timeSelect.appendChild(opt);
          }
        });
      });

      document.getElementById("ctForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const name = document.getElementById("name").value;
        const chart = document.getElementById("chart").value;
        const part = document.getElementById("part").value;
        const time = document.getElementById("time").value;
        const note = document.getElementById("note").value;

        const key = encodeKey(time);
        const refPath = db.ref("appointments/" + key);

        refPath.once("value", async (snapshot) => {
          if (snapshot.exists()) {
            alert("⚠️ 此時段已被預約，請選擇其他時間。");
          } else {
            await refPath.set({
              name,
              chart,
              part,
              note,
              time,
              created: new Date().toISOString()
            });

            alert(`預約成功！\n\n姓名：${name}\n病歷號：${chart}\n部位：${part}\n時段：${time}`);
            document.getElementById("ctForm").reset();
            location.reload();
          }
        });
      });
    });
  </script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: auto; padding: 20px; }
    label { display: block; margin-top: 15px; font-weight: bold; }
    input, select, textarea, button { width: 100%; padding: 8px; margin-top: 5px; font-size: 16px; }
    button { background-color: #4CAF50; color: white; border: none; cursor: pointer; margin-top: 20px; }
    button:hover { background-color: #45a049; }
  </style>
</head>
<body>
  <h2>CT 檢查排程表單</h2>
  <form id="ctForm">
    <label for="name">病人姓名：</label>
    <input type="text" id="name" name="name" required>

    <label for="chart">病歷號：</label>
    <input type="text" id="chart" name="chart" required>

    <label for="part">檢查部位：</label>
    <select id="part" name="part" required>
      <option value="">請選擇</option>
      <option value="Brain">Brain</option>
      <option value="Chest">Chest</option>
      <option value="Abdomen">Abdomen</option>
      <option value="Facial">Facial</option>
      <option value="Tumor">Tumor</option>
    </select>

    <label for="time">檢查時段：</label>
    <select id="time" name="time" required>
      <option value="">請選擇</option>
    </select>

    <label for="note">備註：</label>
    <textarea id="note" name="note" rows="3"></textarea>

    <button type="submit">送出排程</button>
  </form>
</body>
</html>
