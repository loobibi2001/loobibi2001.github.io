
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CT æª¢æŸ¥æ’ç¨‹è¡¨å–®</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: auto; padding: 20px; }
    input, select, button, textarea {
      display: block; width: 100%; margin: 10px 0; padding: 8px; font-size: 16px;
    }
    button { background-color: #4CAF50; color: white; border: none; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    th { background: #f0f0f0; }
    @media print {
      .noprint { display: none !important; }
    }
  </style>
</head>
<body>
  <h2>CT æª¢æŸ¥æ’ç¨‹è¡¨å–®</h2>

  <div class="noprint">
    <label>ç—…äººå§“åï¼š<input id="name" /></label>
    <label>ç—…æ­·è™Ÿï¼š<input id="chart" /></label>
    <label>æª¢æŸ¥éƒ¨ä½ï¼š
      <select id="part">
        <option>è«‹é¸æ“‡</option>
        <option>Brain</option>
        <option>Chest</option>
        <option>Abdomen</option>
        <option>Facial</option>
        <option>Tumor</option>
      </select>
    </label>
    <label>æª¢æŸ¥æ™‚æ®µï¼š
      <select id="time">
        <option>è«‹é¸æ“‡</option>
        <option>08:00</option>
        <option>08:20</option>
        <option>08:40</option>
        <option>09:00</option>
        <option>09:20</option>
        <option>09:40</option>
        <option>10:00</option>
        <option>10:20</option>
        <option>10:40</option>
        <option>11:00</option>
        <option>11:20</option>
        <option>11:40</option>
        <option>13:20</option>
        <option>13:40</option>
        <option>14:00</option>
        <option>14:20</option>
        <option>14:40</option>
        <option>15:00</option>
        <option>15:20</option>
        <option>15:40</option>
        <option>16:00</option>
      </select>
    </label>
    <label>å‚™è¨»ï¼š<textarea id="note"></textarea></label>
    <button onclick="submitForm()">é€å‡ºæ’ç¨‹</button>
    <h3>ğŸ“‹ å·²é ç´„æ¸…å–®</h3>
    <input id="search" placeholder="æœå°‹å§“åã€ç—…æ­·è™Ÿã€éƒ¨ä½æˆ–æ™‚æ®µ..." oninput="renderTable()" />
    <button onclick="loadRecords()">è¼‰å…¥é ç´„ç´€éŒ„</button>
    <button onclick="exportCSV()">åŒ¯å‡º CSV</button>
    <button onclick="window.print()">åˆ—å°æ•´é </button>
  </div>

  <table id="recordTable">
    <thead><tr><th>å§“å</th><th>ç—…æ­·è™Ÿ</th><th>éƒ¨ä½</th><th>æ™‚æ®µ</th><th>å‚™è¨»</th><th class="noprint">æ“ä½œ</th></tr></thead>
    <tbody></tbody>
  </table>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBLgUdGaDarOAQF_5YGo4df6KyU8DsclA0",
      authDomain: "ct-reserve.firebaseapp.com",
      projectId: "ct-reserve",
      storageBucket: "ct-reserve.firebasestorage.app",
      messagingSenderId: "263734590112",
      appId: "1:263734590112:web:34fec465ce56d91f68a7c5"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let allData = [];

    function submitForm() {
      const name = document.getElementById("name").value.trim();
      const chart = document.getElementById("chart").value.trim();
      const part = document.getElementById("part").value;
      const time = document.getElementById("time").value;
      const note = document.getElementById("note").value.trim();
      if (!name || !chart || part === "è«‹é¸æ“‡" || time === "è«‹é¸æ“‡") return alert("è«‹å®Œæ•´å¡«å¯«");
      const record = { name, chart, part, time, note, createdAt: Date.now() };
      db.ref("appointments").push(record, err => {
        if (!err) {
          alert("å·²é€å‡º");
          document.querySelectorAll("input, textarea").forEach(el => el.value = "");
          document.getElementById("part").selectedIndex = 0;
          document.getElementById("time").selectedIndex = 0;
          loadRecords();
        }
      });
    }

    function loadRecords() {
      db.ref("appointments").once("value", snap => {
        allData = [];
        snap.forEach(child => {
          const d = child.val();
          d.key = child.key;
          allData.push(d);
        });
        renderTable();
      });
    }

    function renderTable() {
      const q = document.getElementById("search").value.toLowerCase();
      const tbody = document.querySelector("tbody");
      tbody.innerHTML = "";
      allData.filter(r =>
        !q || Object.values(r).some(v => typeof v === "string" && v.toLowerCase().includes(q))
      ).sort((a, b) => a.time.localeCompare(b.time)).forEach(r => {
        const tr = tbody.insertRow();
        tr.innerHTML = `
          <td>${r.name}</td><td>${r.chart}</td><td>${r.part}</td><td>${r.time}</td><td>${r.note || ""}</td>
          <td class="noprint"><button onclick="removeRecord('${r.key}')">åˆªé™¤</button></td>
        `;
      });
    }

    function removeRecord(key) {
      if (confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) {
        db.ref("appointments/" + key).remove(() => loadRecords());
      }
    }

    function exportCSV() {
      const csv = ["å§“å,ç—…æ­·è™Ÿ,éƒ¨ä½,æ™‚æ®µ,å‚™è¨»"];
      allData.forEach(r => csv.push(`${r.name},${r.chart},${r.part},${r.time},${r.note || ""}`));
      const blob = new Blob(["ï»¿" + csv.join("\n")], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "ct_schedule.csv";
      a.click();
      URL.revokeObjectURL(url);
    }

    window.onload = loadRecords;
  </script>
</body>
</html>
